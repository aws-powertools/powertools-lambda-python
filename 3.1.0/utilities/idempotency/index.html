
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Utility">
      
      
        <meta name="author" content="Amazon Web Services">
      
      
      
        <link rel="prev" href="../parser/">
      
      
        <link rel="next" href="../data_masking/">
      
      
      <link rel="icon" href="../../media/aws-logo-light.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.39">
    
    
      
        <title>Idempotency - Powertools for AWS Lambda (Python)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#key-features" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
On March 25st, 2025 v2 of Powertools for AWS Lambda (Python) <a
  href="https://github.com/aws-powertools/powertools-lambda-python/issues/5239" target="_blank">will reach
  End-of-Life</a>. We recommend you to <a href="https://docs.powertools.aws.dev/lambda/python/latest/upgrade/"
  target="_blank">upgrade to v3</a>.

          </div>
          
        </aside>
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  You're not viewing the latest version.
  <a href="../../..">
    <strong>Click here to go to latest.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Powertools for AWS Lambda (Python)" class="md-header__button md-logo" aria-label="Powertools for AWS Lambda (Python)" data-md-component="logo">
      
  <img src="../../media/aws-logo-light.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Powertools for AWS Lambda (Python)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Idempotency
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-powertools/powertools-lambda-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Homepage

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tutorial/" class="md-tabs__link">
        
  
    
  
  Tutorial

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../security/" class="md-tabs__link">
          
  
    
  
  Processes

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Powertools for AWS Lambda (Python)" class="md-nav__button md-logo" aria-label="Powertools for AWS Lambda (Python)" data-md-component="logo">
      
  <img src="../../media/aws-logo-light.svg" alt="logo">

    </a>
    Powertools for AWS Lambda (Python)
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-powertools/powertools-lambda-python" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Homepage
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Homepage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" target="_blank" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Upgrade guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../we_made_this/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    We Made This (Community)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://s12d.com/powertools-for-aws-lambda-workshop" target="_blank" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Workshop ðŸ†•
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roadmap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_8" checked>
        
          
          <label class="md-nav__link" for="__nav_1_8" id="__nav_1_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Features
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_8">
            <span class="md-nav__icon md-icon"></span>
            Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/tracer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tracer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_8_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../core/metrics/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Metrics
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1_8_3" id="__nav_1_8_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_8_3">
            <span class="md-nav__icon md-icon"></span>
            Metrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Amazon CloudWatch EMF
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/metrics/datadog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Datadog
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_8_4" >
        
          
          <label class="md-nav__link" for="__nav_1_8_4" id="__nav_1_8_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Event Handler
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_1_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_8_4">
            <span class="md-nav__icon md-icon"></span>
            Event Handler
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/event_handler/api_gateway/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    REST API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/event_handler/appsync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GraphQL API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/event_handler/bedrock_agents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Agents for Amazon Bedrock
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../parameters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Parameters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../batch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Batch Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../typing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Typing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Validation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data_classes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Event Source Data Classes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../parser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Parser (Pydantic)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Idempotency
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Idempotency
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    <span class="md-ellipsis">
      Terminology
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iam-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      IAM Permissions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Required resources
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Required resources">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodb-table" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB table
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamoDB table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodb-iac-examples" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB IaC examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limitations" class="md-nav__link">
    <span class="md-ellipsis">
      Limitations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-database" class="md-nav__link">
    <span class="md-ellipsis">
      Redis database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Redis database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis-iac-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Redis IaC examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotent-decorator" class="md-nav__link">
    <span class="md-ellipsis">
      Idempotent decorator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotent_function-decorator" class="md-nav__link">
    <span class="md-ellipsis">
      Idempotent_function decorator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Idempotent_function decorator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#output-serialization" class="md-nav__link">
    <span class="md-ellipsis">
      Output serialization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-in-memory-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Using in-memory cache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choosing-a-payload-subset" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing a payload subset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjusting-expiration-window" class="md-nav__link">
    <span class="md-ellipsis">
      Adjusting expiration window
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda timeouts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      Handling exceptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Persistence layers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistence layers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodbpersistencelayer" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDBPersistenceLayer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamoDBPersistenceLayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-a-composite-primary-key" class="md-nav__link">
    <span class="md-ellipsis">
      Using a composite primary key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redispersistencelayer" class="md-nav__link">
    <span class="md-ellipsis">
      RedisPersistenceLayer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RedisPersistenceLayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis-ssl-connections" class="md-nav__link">
    <span class="md-ellipsis">
      Redis SSL connections
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Redis attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Common use cases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common use cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#batch-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Batch processing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotency-request-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Idempotency request flow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Idempotency request flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#successful-request" class="md-nav__link">
    <span class="md-ellipsis">
      Successful request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#successful-request-with-cache-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      Successful request with cache enabled
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#successful-request-with-response_hook-configured" class="md-nav__link">
    <span class="md-ellipsis">
      Successful request with response_hook configured
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expired-idempotency-records" class="md-nav__link">
    <span class="md-ellipsis">
      Expired idempotency records
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrent-identical-in-flight-requests" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrent identical in-flight requests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unhandled-exception" class="md-nav__link">
    <span class="md-ellipsis">
      Unhandled exception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-request-timeout" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda request timeout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-idempotency-key" class="md-nav__link">
    <span class="md-ellipsis">
      Optional idempotency key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#race-condition-with-redis" class="md-nav__link">
    <span class="md-ellipsis">
      Race condition with Redis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-default-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing the default behavior
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-concurrent-executions-with-the-same-payload" class="md-nav__link">
    <span class="md-ellipsis">
      Handling concurrent executions with the same payload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payload-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Payload validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-idempotency-key-required" class="md-nav__link">
    <span class="md-ellipsis">
      Making idempotency key required
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-boto-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing boto configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bring-your-own-persistent-store" class="md-nav__link">
    <span class="md-ellipsis">
      Bring your own persistent store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manipulating-the-idempotent-response" class="md-nav__link">
    <span class="md-ellipsis">
      Manipulating the Idempotent Response
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manipulating the Idempotent Response">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#being-a-good-citizen" class="md-nav__link">
    <span class="md-ellipsis">
      Being a good citizen
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compatibility-with-other-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      Compatibility with other utilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compatibility with other utilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#json-schema-validation" class="md-nav__link">
    <span class="md-ellipsis">
      JSON Schema Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracer" class="md-nav__link">
    <span class="md-ellipsis">
      Tracer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tracer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-execution" class="md-nav__link">
    <span class="md-ellipsis">
      First execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subsequent-executions" class="md-nav__link">
    <span class="md-ellipsis">
      Subsequent executions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-your-code" class="md-nav__link">
    <span class="md-ellipsis">
      Testing your code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing your code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disabling-the-idempotency-utility" class="md-nav__link">
    <span class="md-ellipsis">
      Disabling the idempotency utility
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-dynamodb-local" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with DynamoDB Local
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-do-i-mock-all-dynamodb-io-operations" class="md-nav__link">
    <span class="md-ellipsis">
      How do I mock all DynamoDB I/O operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-redis" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with Redis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extra-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Extra resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data_masking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Masking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../feature_flags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Feature flags
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../streaming/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Streaming
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../middleware_factory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Middleware factory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../jmespath_functions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JMESPath Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/aws-cloudformation/custom-resource-helper" target="_blank" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CloudFormation Custom Resources
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Processes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Processes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Security
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../automation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../versioning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Versioning policy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roadmap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../maintainers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Maintainers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Contributing
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Contributing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development environment
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Your first contribution
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/conventions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Conventions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key features
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    <span class="md-ellipsis">
      Terminology
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    <span class="md-ellipsis">
      Getting started
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#iam-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      IAM Permissions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Required resources
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Required resources">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodb-table" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB table
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamoDB table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodb-iac-examples" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB IaC examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limitations" class="md-nav__link">
    <span class="md-ellipsis">
      Limitations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-database" class="md-nav__link">
    <span class="md-ellipsis">
      Redis database
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Redis database">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis-iac-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Redis IaC examples
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotent-decorator" class="md-nav__link">
    <span class="md-ellipsis">
      Idempotent decorator
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotent_function-decorator" class="md-nav__link">
    <span class="md-ellipsis">
      Idempotent_function decorator
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Idempotent_function decorator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#output-serialization" class="md-nav__link">
    <span class="md-ellipsis">
      Output serialization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-in-memory-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Using in-memory cache
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choosing-a-payload-subset" class="md-nav__link">
    <span class="md-ellipsis">
      Choosing a payload subset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjusting-expiration-window" class="md-nav__link">
    <span class="md-ellipsis">
      Adjusting expiration window
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda timeouts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      Handling exceptions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Persistence layers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Persistence layers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodbpersistencelayer" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDBPersistenceLayer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamoDBPersistenceLayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-a-composite-primary-key" class="md-nav__link">
    <span class="md-ellipsis">
      Using a composite primary key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redispersistencelayer" class="md-nav__link">
    <span class="md-ellipsis">
      RedisPersistenceLayer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RedisPersistenceLayer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis-ssl-connections" class="md-nav__link">
    <span class="md-ellipsis">
      Redis SSL connections
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-attributes" class="md-nav__link">
    <span class="md-ellipsis">
      Redis attributes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      Common use cases
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common use cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#batch-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Batch processing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotency-request-flow" class="md-nav__link">
    <span class="md-ellipsis">
      Idempotency request flow
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Idempotency request flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#successful-request" class="md-nav__link">
    <span class="md-ellipsis">
      Successful request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#successful-request-with-cache-enabled" class="md-nav__link">
    <span class="md-ellipsis">
      Successful request with cache enabled
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#successful-request-with-response_hook-configured" class="md-nav__link">
    <span class="md-ellipsis">
      Successful request with response_hook configured
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expired-idempotency-records" class="md-nav__link">
    <span class="md-ellipsis">
      Expired idempotency records
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrent-identical-in-flight-requests" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrent identical in-flight requests
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unhandled-exception" class="md-nav__link">
    <span class="md-ellipsis">
      Unhandled exception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-request-timeout" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda request timeout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optional-idempotency-key" class="md-nav__link">
    <span class="md-ellipsis">
      Optional idempotency key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#race-condition-with-redis" class="md-nav__link">
    <span class="md-ellipsis">
      Race condition with Redis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-default-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing the default behavior
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-concurrent-executions-with-the-same-payload" class="md-nav__link">
    <span class="md-ellipsis">
      Handling concurrent executions with the same payload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payload-validation" class="md-nav__link">
    <span class="md-ellipsis">
      Payload validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-idempotency-key-required" class="md-nav__link">
    <span class="md-ellipsis">
      Making idempotency key required
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-boto-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Customizing boto configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bring-your-own-persistent-store" class="md-nav__link">
    <span class="md-ellipsis">
      Bring your own persistent store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manipulating-the-idempotent-response" class="md-nav__link">
    <span class="md-ellipsis">
      Manipulating the Idempotent Response
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manipulating the Idempotent Response">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#being-a-good-citizen" class="md-nav__link">
    <span class="md-ellipsis">
      Being a good citizen
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compatibility-with-other-utilities" class="md-nav__link">
    <span class="md-ellipsis">
      Compatibility with other utilities
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Compatibility with other utilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#json-schema-validation" class="md-nav__link">
    <span class="md-ellipsis">
      JSON Schema Validation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tracer" class="md-nav__link">
    <span class="md-ellipsis">
      Tracer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tracer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#first-execution" class="md-nav__link">
    <span class="md-ellipsis">
      First execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subsequent-executions" class="md-nav__link">
    <span class="md-ellipsis">
      Subsequent executions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-your-code" class="md-nav__link">
    <span class="md-ellipsis">
      Testing your code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Testing your code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disabling-the-idempotency-utility" class="md-nav__link">
    <span class="md-ellipsis">
      Disabling the idempotency utility
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-dynamodb-local" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with DynamoDB Local
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-do-i-mock-all-dynamodb-io-operations" class="md-nav__link">
    <span class="md-ellipsis">
      How do I mock all DynamoDB I/O operations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-redis" class="md-nav__link">
    <span class="md-ellipsis">
      Testing with Redis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extra-resources" class="md-nav__link">
    <span class="md-ellipsis">
      Extra resources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Idempotency</h1>

<!-- markdownlint-disable MD051 -->

<p>The idempotency utility allows you to retry operations within a time window with the same input, producing the same output.</p>
<h2 id="key-features">Key features<a class="headerlink" href="#key-features" title="Permanent link">&para;</a></h2>
<ul>
<li>Produces the previous successful result when a function is called repeatedly with the same idempotency key</li>
<li>Choose your idempotency key from one or more fields, or entire payload</li>
<li>Safeguard concurrent requests, timeouts, missing idempotency keys, and payload tampering</li>
<li>Support for Amazon DynamoDB, Redis, bring your own persistence layer, and in-memory caching</li>
</ul>
<h2 id="terminology">Terminology<a class="headerlink" href="#terminology" title="Permanent link">&para;</a></h2>
<p>The property of idempotency means that an operation does not cause additional side effects if it is called more than once with the same input parameters.</p>
<p><strong>Idempotency key</strong> is a combination of <strong>(a)</strong> Lambda function name, <strong>(b)</strong> fully qualified name of your function, and <strong>(c)</strong> a hash of the entire payload or part(s) of the payload you specify.</p>
<p><strong>Idempotent request</strong> is an operation with the same input previously processed that is not expired in your persistent storage or in-memory cache.</p>
<p><strong>Persistence layer</strong> is a storage we use to create, read, expire, and delete idempotency records.</p>
<p><strong>Idempotency record</strong> is the data representation of an idempotent request saved in the persistent layer and in its various status. We use it to coordinate  whether <strong>(a)</strong> a request is idempotent, <strong>(b)</strong> it's not expired, <strong>(c)</strong> JSON response to return, and more.</p>
<p><center>
<pre class="mermaid"><code>classDiagram
    direction LR
    class IdempotencyRecord {
        idempotency_key str
        status Status
        expiry_timestamp int
        in_progress_expiry_timestamp int
        response_data str~JSON~
        payload_hash str
    }
    class Status {
        &lt;&lt;Enumeration&gt;&gt;
        INPROGRESS
        COMPLETE
        EXPIRED internal_only
    }
    IdempotencyRecord -- Status</code></pre></p>
<p><i>Idempotency record representation</i>
</center></p>
<h2 id="getting-started">Getting started<a class="headerlink" href="#getting-started" title="Permanent link">&para;</a></h2>
<p>We use Amazon DynamoDB as the default persistence layer in the documentation. If you prefer Redis, you can learn more from <a href="#redis-database">this section</a>.</p>
<h3 id="iam-permissions">IAM Permissions<a class="headerlink" href="#iam-permissions" title="Permanent link">&para;</a></h3>
<p>When using Amazon DynamoDB as the persistence layer, you will need the following IAM permissions:</p>
<table>
<thead>
<tr>
<th>IAM Permission</th>
<th>Operation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong class="copyMe"><code>dynamodb:GetItem</code></strong></td>
<td>Retrieve idempotent record <em>(strong consistency)</em></td>
</tr>
<tr>
<td><strong class="copyMe"><code>dynamodb:PutItem</code></strong></td>
<td>New idempotent records, replace expired idempotent records</td>
</tr>
<tr>
<td><strong class="copyMe"><code>dynamodb:UpdateItem</code></strong></td>
<td>Complete idempotency transaction, and/or update idempotent records state</td>
</tr>
<tr>
<td><strong class="copyMe"><code>dynamodb:DeleteItem</code></strong></td>
<td>Delete idempotent records for unsuccessful idempotency transactions</td>
</tr>
</tbody>
</table>
<p><strong>First time setting it up?</strong></p>
<p>We provide Infrastrucure as Code examples with <a href="#aws-serverless-application-model-sam-example">AWS Serverless Application Model (SAM)</a>, <a href="#aws-cloud-development-kit-cdk">AWS Cloud Development Kit (CDK)</a>, and <a href="#terraform">Terraform</a> with the required permissions.</p>
<h3 id="required-resources">Required resources<a class="headerlink" href="#required-resources" title="Permanent link">&para;</a></h3>
<p>To start, you'll need:</p>
<!-- markdownlint-disable MD030 -->

<div class="grid cards">
<ul>
<li>
<p><span class="twemoji lg middle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 3.5c0-.626.292-1.165.7-1.59.406-.422.956-.767 1.579-1.041C4.525.32 6.195 0 8 0s3.475.32 4.722.869c.622.274 1.172.62 1.578 1.04.408.426.7.965.7 1.591v9c0 .626-.292 1.165-.7 1.59-.406.422-.956.767-1.579 1.041C11.476 15.68 9.806 16 8 16c-1.805 0-3.475-.32-4.721-.869-.623-.274-1.173-.62-1.579-1.04-.408-.426-.7-.965-.7-1.591Zm1.5 0c0 .133.058.318.282.551.227.237.591.483 1.101.707C4.898 5.205 6.353 5.5 8 5.5s3.101-.295 4.118-.742c.508-.224.873-.471 1.1-.708.224-.232.282-.417.282-.55s-.058-.318-.282-.551c-.227-.237-.591-.483-1.101-.707C11.102 1.795 9.647 1.5 8 1.5s-3.101.295-4.118.742c-.508.224-.873.471-1.1.708-.224.232-.282.417-.282.55m0 4.5c0 .133.058.318.282.551.227.237.591.483 1.101.707C4.898 9.705 6.353 10 8 10s3.101-.295 4.118-.742c.508-.224.873-.471 1.1-.708.224-.232.282-.417.282-.55V5.724c-.241.15-.503.286-.778.407C11.475 6.68 9.805 7 8 7s-3.475-.32-4.721-.869a6 6 0 0 1-.779-.407Zm0 2.225V12.5c0 .133.058.318.282.55.227.237.592.484 1.1.708 1.016.447 2.471.742 4.118.742s3.102-.295 4.117-.742c.51-.224.874-.47 1.101-.707.224-.233.282-.418.282-.551v-2.275c-.241.15-.503.285-.778.406-1.247.549-2.917.869-4.722.869s-3.475-.32-4.721-.869a6 6 0 0 1-.779-.406"/></svg></span> <strong>Persistent storage</strong></p>
<hr />
<p><a href="#dynamodb-table">Amazon DynamoDB</a> or <a href="#redis-database">Redis</a></p>
</li>
<li>
<p><span class="twemoji lg middle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4.986 0a.545.545 0 0 0-.534.548l-.006 4.908c0 .145.06.283.159.39a.53.53 0 0 0 .38.155h3.429l8.197 17.68a.54.54 0 0 0 .488.319h5.811a.547.547 0 0 0 .543-.548v-4.908a.543.543 0 0 0-.543-.548h-2.013L12.739.316A.55.55 0 0 0 12.245 0H4.991Zm.54 1.09h6.367l8.16 17.681a.54.54 0 0 0 .489.318h1.817v3.817h-4.922L9.24 5.226a.54.54 0 0 0-.488-.318h-3.23Zm2.013 8.237a.54.54 0 0 0-.486.31L.6 23.213a.55.55 0 0 0 .032.528.53.53 0 0 0 .454.25h6.169a.55.55 0 0 0 .497-.31l3.38-7.165a.54.54 0 0 0-.003-.469l-3.093-6.41a.55.55 0 0 0-.494-.31Zm.006 1.804 2.488 5.152-3.122 6.62H1.947Z"/></svg></span> <strong>AWS Lambda function</strong></p>
<hr />
<p>With permissions to use your persistent storage</p>
</li>
</ul>
</div>
<!-- markdownlint-enable MD030 -->

<div class="admonition note">
<p class="admonition-title">Primary key for any persistence storage</p>
<p>We combine the Lambda function name and the <a href="https://peps.python.org/pep-3155/" rel="nofollow" target="_blank">fully qualified name</a> for classes/functions to
prevent accidental reuse for similar code sharing input/output.</p>
<p>Primary key sample: <code>{lambda_fn_name}.{module_name}.{fn_qualified_name}#{idempotency_key_hash}</code></p>
</div>
<h4 id="dynamodb-table">DynamoDB table<a class="headerlink" href="#dynamodb-table" title="Permanent link">&para;</a></h4>
<p>Unless you're looking to use an <a href="#dynamodbpersistencelayer">existing table or customize each attribute</a>, you only need the following:</p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Partition key</td>
<td><code>id</code></td>
<td></td>
</tr>
<tr>
<td>TTL attribute name</td>
<td><code>expiration</code></td>
<td>Using AWS Console? This is configurable after table creation</td>
</tr>
</tbody>
</table>
<p>You <strong>can</strong> use a single DynamoDB table for all functions annotated with Idempotency.</p>
<h5 id="dynamodb-iac-examples">DynamoDB IaC examples<a class="headerlink" href="#dynamodb-iac-examples" title="Permanent link">&para;</a></h5>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="aws-serverless-application-model-sam-example" name="__tabbed_1" type="radio" /><input id="aws-cloud-development-kit-cdk" name="__tabbed_1" type="radio" /><input id="terraform" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="aws-serverless-application-model-sam-example">AWS Serverless Application Model (SAM) example</label><label for="aws-cloud-development-kit-cdk">AWS Cloud Development Kit (CDK)</label><label for="terraform">Terraform</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">Transform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless-2016-10-31</span>
<span class="nt">Resources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">IdempotencyTable</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::DynamoDB::Table</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="hll"><span class="w">      </span><span class="nt">AttributeDefinitions</span><span class="p">:</span>
</span><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">AttributeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id</span>
</span><span class="hll"><span class="w">          </span><span class="nt">AttributeType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">S</span>
</span><span class="hll"><span class="w">      </span><span class="nt">KeySchema</span><span class="p">:</span>
</span><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">AttributeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id</span>
</span><span class="hll"><span class="w">          </span><span class="nt">KeyType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HASH</span>
</span><span class="hll"><span class="w">      </span><span class="nt">TimeToLiveSpecification</span><span class="p">:</span>
</span><span class="hll"><span class="w">        </span><span class="nt">AttributeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">expiration</span>
</span><span class="hll"><span class="w">        </span><span class="nt">Enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span class="w">      </span><span class="nt">BillingMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PAY_PER_REQUEST</span>

<span class="w">  </span><span class="nt">HelloWorldFunction</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.12</span>
<span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app.py</span>
<span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Statement</span><span class="p">:</span>
<span class="hll"><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Sid</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AllowDynamodbReadWrite</span>
</span><span class="hll"><span class="w">              </span><span class="nt">Effect</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Allow</span>
</span><span class="hll"><span class="w">              </span><span class="nt">Action</span><span class="p">:</span>
</span><span class="hll"><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:PutItem</span>
</span><span class="hll"><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:GetItem</span>
</span><span class="hll"><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:UpdateItem</span>
</span><span class="hll"><span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dynamodb:DeleteItem</span>
</span><span class="hll"><span class="w">              </span><span class="nt">Resource</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IdempotencyTable.Arn</span>
</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="w">          </span><span class="nt">IDEMPOTENCY_TABLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IdempotencyTable</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_cdk</span> <span class="kn">import</span> <span class="n">RemovalPolicy</span>
<span class="kn">from</span> <span class="nn">aws_cdk</span> <span class="kn">import</span> <span class="n">aws_dynamodb</span> <span class="k">as</span> <span class="n">dynamodb</span>
<span class="kn">from</span> <span class="nn">aws_cdk</span> <span class="kn">import</span> <span class="n">aws_iam</span> <span class="k">as</span> <span class="n">iam</span>
<span class="kn">from</span> <span class="nn">constructs</span> <span class="kn">import</span> <span class="n">Construct</span>


<span class="k">class</span> <span class="nc">IdempotencyConstruct</span><span class="p">(</span><span class="n">Construct</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">:</span> <span class="n">Construct</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">lambda_role</span><span class="p">:</span> <span class="n">iam</span><span class="o">.</span><span class="n">Role</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">idempotency_table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
</span>            <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;IdempotencyTable&quot;</span><span class="p">,</span>
<span class="hll">            <span class="n">partition_key</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">Attribute</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">AttributeType</span><span class="o">.</span><span class="n">STRING</span><span class="p">),</span>
</span>            <span class="n">billing_mode</span><span class="o">=</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">BillingMode</span><span class="o">.</span><span class="n">PAY_PER_REQUEST</span><span class="p">,</span>
            <span class="n">removal_policy</span><span class="o">=</span><span class="n">RemovalPolicy</span><span class="o">.</span><span class="n">DESTROY</span><span class="p">,</span>
<span class="hll">            <span class="n">time_to_live_attribute</span><span class="o">=</span><span class="s2">&quot;expiration&quot;</span><span class="p">,</span>
</span>            <span class="n">point_in_time_recovery</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">idempotency_table</span><span class="o">.</span><span class="n">grant</span><span class="p">(</span>
</span><span class="hll">            <span class="n">lambda_role</span><span class="p">,</span>
</span><span class="hll">            <span class="s2">&quot;dynamodb:PutItem&quot;</span><span class="p">,</span>
</span>            <span class="s2">&quot;dynamodb:GetItem&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamodb:UpdateItem&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dynamodb:DeleteItem&quot;</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">aws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/aws&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 4.0&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;aws&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;us-east-1&quot;</span><span class="c1"> # Replace with your desired AWS region</span>
<span class="p">}</span>

<span class="hll"><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_dynamodb_table&quot;</span><span class="w"> </span><span class="nv">&quot;IdempotencyTable&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">  </span><span class="na">name</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;IdempotencyTable&quot;</span>
</span><span class="hll"><span class="w">  </span><span class="na">billing_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PAY_PER_REQUEST&quot;</span>
</span><span class="hll"><span class="w">  </span><span class="na">hash_key</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;id&quot;</span>
</span><span class="hll"><span class="w">  </span><span class="nb">attribute</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;id&quot;</span>
</span><span class="hll"><span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S&quot;</span>
</span><span class="hll"><span class="w">  </span><span class="p">}</span>
</span><span class="hll"><span class="w">  </span><span class="nb">ttl</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="na">attribute_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;expiration&quot;</span>
</span><span class="hll"><span class="w">    </span><span class="na">enabled</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
</span><span class="hll"><span class="w">  </span><span class="p">}</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_function&quot;</span><span class="w"> </span><span class="nv">&quot;IdempotencyFunction&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;IdempotencyFunction&quot;</span>
<span class="w">  </span><span class="na">role</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.IdempotencyFunctionRole.arn</span>
<span class="w">  </span><span class="na">runtime</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python3.12&quot;</span>
<span class="w">  </span><span class="na">handler</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;app.lambda_handler&quot;</span>
<span class="w">  </span><span class="na">filename</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda.zip&quot;</span>

<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role&quot;</span><span class="w"> </span><span class="nv">&quot;IdempotencyFunctionRole&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;IdempotencyFunctionRole&quot;</span>

<span class="w">  </span><span class="na">assume_role_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span>
<span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="na">Sid</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">        </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="w">        </span><span class="nb">Principal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="na">Service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda.amazonaws.com&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sts:AssumeRole&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_policy&quot;</span><span class="w"> </span><span class="nv">&quot;LambdaDynamoDBPolicy&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;LambdaDynamoDBPolicy&quot;</span>
<span class="w">  </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;IAM policy for Lambda function to access DynamoDB&quot;</span>
<span class="w">  </span><span class="na">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">({</span>
<span class="w">    </span><span class="na">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2012-10-17&quot;</span>
<span class="w">    </span><span class="na">Statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="na">Sid</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;AllowDynamodbReadWrite&quot;</span>
<span class="w">        </span><span class="na">Effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Allow&quot;</span>
<span class="hll"><span class="w">        </span><span class="na">Action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
</span><span class="hll"><span class="w">          </span><span class="s2">&quot;dynamodb:PutItem&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="w">          </span><span class="s2">&quot;dynamodb:GetItem&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="w">          </span><span class="s2">&quot;dynamodb:UpdateItem&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="w">          </span><span class="s2">&quot;dynamodb:DeleteItem&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="w">        </span><span class="p">]</span>
</span><span class="hll"><span class="w">        </span><span class="na">Resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_dynamodb_table.IdempotencyTable.arn</span>
</span><span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>

<span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role_policy_attachment&quot;</span><span class="w"> </span><span class="nv">&quot;IdempotencyFunctionRoleAttachment&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">role</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.IdempotencyFunctionRole.name</span>
<span class="w">  </span><span class="na">policy_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_policy.LambdaDynamoDBPolicy.arn</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>`</p>
<h5 id="limitations">Limitations<a class="headerlink" href="#limitations" title="Permanent link">&para;</a></h5>
<ul>
<li>
<p><strong>DynamoDB restricts <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Limits.html#limits-items" target="_blank">item sizes to 400KB</a></strong>. This means that if your annotated function's response must be smaller than 400KB, otherwise your function will fail. Consider <a href="#redis-database">Redis</a> as an alternative.</p>
</li>
<li>
<p><strong>Expect 2 WCU per non-idempotent call</strong>. During the first invocation, we use <code>PutItem</code> for locking and <code>UpdateItem</code> for completion. Consider reviewing <a href="https://aws.amazon.com/dynamodb/pricing/" target="_blank">DynamoDB pricing documentation</a> to estimate cost.</p>
</li>
<li>
<p><strong>Old boto3 versions can increase costs</strong>. For cost optimization, we use a conditional <code>PutItem</code> to always lock a new idempotency record. If locking fails, it means we already have an idempotency record saving us an additional <code>GetItem</code> call. However, this is only supported in boto3 <code>1.26.194</code> and higher <em>(<a href="https://aws.amazon.com/about-aws/whats-new/2023/06/amazon-dynamodb-cost-failed-conditional-writes/" target="_blank">June 30th 2023</a>)</em>.</p>
</li>
</ul>
<h4 id="redis-database">Redis database<a class="headerlink" href="#redis-database" title="Permanent link">&para;</a></h4>
<p>We recommend you start with a Redis compatible management services such as <a href="https://aws.amazon.com/elasticache/redis/" target="_blank">Amazon ElastiCache for Redis</a> or <a href="https://aws.amazon.com/memorydb/" target="_blank">Amazon MemoryDB for Redis</a>.</p>
<p>In both services, you'll need to configure <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html" target="_blank">VPC access</a> to your AWS Lambda.</p>
<h5 id="redis-iac-examples">Redis IaC examples<a class="headerlink" href="#redis-iac-examples" title="Permanent link">&para;</a></h5>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="aws-cloudformation-example" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="aws-cloudformation-example">AWS CloudFormation example</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition tip inline end">
<p class="admonition-title">Prefer AWS Console/CLI?</p>
<p>Follow the official tutorials for <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/LambdaRedis.html">Amazon ElastiCache for Redis</a> or <a href="https://aws.amazon.com/blogs/database/access-amazon-memorydb-for-redis-from-aws-lambda/">Amazon MemoryDB for Redis</a></p>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">AWSTemplateFormatVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2010-09-09&quot;</span>
<span class="nt">Transform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless-2016-10-31</span>

<span class="nt">Resources</span><span class="p">:</span>
<span class="hll"><span class="w">  </span><span class="nt">RedisServerlessIdempotency</span><span class="p">:</span>
</span><span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::ElastiCache::ServerlessCache</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Engine</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
<span class="w">      </span><span class="nt">ServerlessCacheName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis-cache</span>
<span class="w">      </span><span class="nt">SecurityGroupIds</span><span class="p">:</span><span class="w"> </span><span class="c1"># (1)!</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security-{your_sg_id}</span>
<span class="w">      </span><span class="nt">SubnetIds</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">subnet-{your_subnet_id_1}</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">subnet-{your_subnet_id_2}</span>

<span class="w">  </span><span class="nt">HelloWorldFunction</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">Runtime</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">python3.12</span>
<span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app.py</span>
<span class="hll"><span class="w">      </span><span class="nt">VpcConfig</span><span class="p">:</span><span class="w"> </span><span class="c1"># (1)!</span>
</span><span class="w">        </span><span class="nt">SecurityGroupIds</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">security-{your_sg_id}</span>
<span class="w">        </span><span class="nt">SubnetIds</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">subnet-{your_subnet_id_1}</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">subnet-{your_subnet_id_2}</span>
<span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="w">          </span><span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sample</span>
<span class="w">          </span><span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RedisServerlessIdempotency.Endpoint.Address</span>
<span class="w">          </span><span class="nt">REDIS_PORT</span><span class="p">:</span><span class="w"> </span><span class="kt">!GetAtt</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RedisServerlessIdempotency.Endpoint.Port</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Replace the Security Group ID and Subnet ID to match your VPC settings.</li>
<li>Replace the Security Group ID and Subnet ID to match your VPC settings.</li>
</ol>
</div>
</div>
</div>
<p>Once setup, you can find a quick start and advanced examples for Redis in <a href="#redispersistencelayer">the persistent layers section</a>.</p>
<!-- markdownlint-enable MD013 -->

<h3 id="idempotent-decorator">Idempotent decorator<a class="headerlink" href="#idempotent-decorator" title="Permanent link">&para;</a></h3>
<p>For simple use cases, you can use the <code>idempotent</code> decorator on your Lambda handler function.</p>
<p>It will treat the entire event as an idempotency key. That is, the same event will return the previously stored result within a <a href="#adjusting-expiration-window">configurable time window</a> <em>(1 hour, by default)</em>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="idempotent-decorator_1" name="__tabbed_3" type="radio" /><input id="sample-event" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="idempotent-decorator_1">Idempotent decorator</label><label for="sample-event">Sample event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition tip">
<p class="admonition-title">You can also choose <a href="#choosing-a-payload-subset">one or more fields</a> as an idempotency key.</p>
</div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">getting_started_with_idempotency.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
</span><span class="hll">    <span class="n">idempotent</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Payment</span><span class="p">:</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PaymentError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="o">...</span>


<span class="hll"><span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payment</span><span class="p">:</span> <span class="n">Payment</span> <span class="o">=</span> <span class="n">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="n">payment</span><span class="o">.</span><span class="n">payment_id</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PaymentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating payment </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Payment</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Payment</span><span class="p">(</span><span class="o">**</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">getting_started_with_idempotency_payload.json</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;product_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123456789&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="idempotent_function-decorator">Idempotent_function decorator<a class="headerlink" href="#idempotent_function-decorator" title="Permanent link">&para;</a></h3>
<p>For full flexibility, you can use the <code>idempotent_function</code> decorator for any synchronous Python function.</p>
<p>When using this decorator, you <strong>must</strong> call your decorated function using keyword arguments.</p>
<p>You can use <code>data_keyword_argument</code> to tell us the argument to extract an idempotency key.  We support JSON serializable data, <a href="https://docs.python.org/3.12/library/dataclasses.html" rel="nofollow" target="_blank">Dataclasses</a>, Pydantic Models, and <a href="../data_classes/" target="_blank">Event Source Data Classes</a></p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="using-dataclasses" name="__tabbed_4" type="radio" /><input id="using-pydantic" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="using-dataclasses">Using Dataclasses</label><label for="using-pydantic">Using Pydantic</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">working_with_idempotent_function_dataclass.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
</span><span class="hll">    <span class="n">IdempotencyConfig</span><span class="p">,</span>
</span><span class="hll">    <span class="n">idempotent_function</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
</span><span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">)</span>  <span class="c1"># see Choosing a payload subset section</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">OrderItem</span><span class="p">:</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">OrderItem</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="hll"><span class="nd">@idempotent_function</span><span class="p">(</span><span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>  <span class="c1"># (1)!</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;processed order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="c1"># see Lambda timeouts section</span>
    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># (2)!</span>

    <span class="n">order_item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">order_item</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># `order` parameter must be called as a keyword argument to work</span>
<span class="hll">    <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>Notice how <strong><code>data_keyword_argument</code></strong> matches the name of the parameter.
<br><br> This allows us to extract one or all fields as idempotency key.</li>
<li>Different from <code>idempotent</code> decorator, we must explicitly register the Lambda context to <a href="#lambda-timeouts">protect against timeouts</a>.</li>
</ol>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">working_with_idempotent_function_pydantic.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
</span><span class="hll">    <span class="n">IdempotencyConfig</span><span class="p">,</span>
</span><span class="hll">    <span class="n">idempotent_function</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.parser</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
</span><span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">)</span>  <span class="c1"># see Choosing a payload subset section</span>


<span class="k">class</span> <span class="nc">OrderItem</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">OrderItem</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="hll"><span class="nd">@idempotent_function</span><span class="p">(</span><span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;processed order </span><span class="si">{</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># see Lambda timeouts section</span>
    <span class="n">order_item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">order_item</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># `order` parameter must be called as a keyword argument to work</span>
<span class="hll">    <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h4 id="output-serialization">Output serialization<a class="headerlink" href="#output-serialization" title="Permanent link">&para;</a></h4>
<p>By default, <code>idempotent_function</code> serializes, stores, and returns your annotated function's result as a JSON object. You can change this behavior using <code>output_serializer</code> parameter.</p>
<p>The output serializer supports any JSON serializable data, <strong>Python Dataclasses</strong> and <strong>Pydantic Models</strong>.</p>
<div class="admonition info">
<p class="admonition-title">When using the <code>output_serializer</code> parameter, the data will continue to be stored in your persistent storage as a JSON string.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="pydantic" name="__tabbed_5" type="radio" /><input id="dataclasses" name="__tabbed_5" type="radio" /><input id="any-type" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="pydantic">Pydantic</label><label for="dataclasses">Dataclasses</label><label for="any-type">Any type</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>Use <code>PydanticSerializer</code> to automatically serialize what's retrieved from the persistent storage based on the return type annotated.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="inferring-via-the-return-type" name="__tabbed_6" type="radio" /><input id="explicit-model-type" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="inferring-via-the-return-type">Inferring via the return type</label><label for="explicit-model-type">Explicit model type</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.serialization.pydantic</span> <span class="kn">import</span> <span class="n">PydanticSerializer</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.parser</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">)</span>  <span class="c1"># see Choosing a payload subset section</span>


<span class="k">class</span> <span class="nc">OrderItem</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">OrderItem</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="hll"><span class="k">class</span> <span class="nc">OrderOutput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@idempotent_function</span><span class="p">(</span>
    <span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">,</span>
<span class="hll">    <span class="n">output_serializer</span><span class="o">=</span><span class="n">PydanticSerializer</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="c1"># order output is inferred from return type</span>
<span class="hll"><span class="k">def</span> <span class="nf">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderOutput</span><span class="p">:</span>  <span class="c1"># (1)!</span>
</span>    <span class="k">return</span> <span class="n">OrderOutput</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># see Lambda timeouts section</span>
    <span class="n">order_item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">order_item</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># `order` parameter must be called as a keyword argument to work</span>
<span class="hll">    <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>We'll use <code>OrderOutput</code> to instantiate a new object using the data retrieved from persistent storage as input. <br><br> This ensures the return of the function is not impacted when <code>@idempotent_function</code> is used.</li>
</ol>
</div>
<div class="tabbed-block">
<p>Alternatively, you can provide an explicit model as an input to <code>PydanticSerializer</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.serialization.pydantic</span> <span class="kn">import</span> <span class="n">PydanticSerializer</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.parser</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">)</span>  <span class="c1"># see Choosing a payload subset section</span>


<span class="k">class</span> <span class="nc">OrderItem</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">OrderItem</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="hll"><span class="k">class</span> <span class="nc">OrderOutput</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@idempotent_function</span><span class="p">(</span>
    <span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">,</span>
<span class="hll">    <span class="n">output_serializer</span><span class="o">=</span><span class="n">PydanticSerializer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">OrderOutput</span><span class="p">),</span>
</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">OrderOutput</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># see Lambda timeouts section</span>
    <span class="n">order_item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">order_item</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># `order` parameter must be called as a keyword argument to work</span>
<span class="hll">    <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>Use <code>DataclassSerializer</code> to automatically serialize what's retrieved from the persistent storage based on the return type annotated.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="inferring-via-the-return-type_1" name="__tabbed_7" type="radio" /><input id="explicit-model-type_1" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="inferring-via-the-return-type_1">Inferring via the return type</label><label for="explicit-model-type_1">Explicit model type</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.serialization.dataclass</span> <span class="kn">import</span> <span class="n">DataclassSerializer</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">)</span>  <span class="c1"># see Choosing a payload subset section</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">OrderItem</span><span class="p">:</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">OrderItem</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@dataclass</span>
<span class="hll"><span class="k">class</span> <span class="nc">OrderOutput</span><span class="p">:</span>
</span>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@idempotent_function</span><span class="p">(</span>
    <span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">,</span>
<span class="hll">    <span class="n">output_serializer</span><span class="o">=</span><span class="n">DataclassSerializer</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="c1"># order output is inferred from return type</span>
<span class="hll"><span class="k">def</span> <span class="nf">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderOutput</span><span class="p">:</span>  <span class="c1"># (1)!</span>
</span>    <span class="k">return</span> <span class="n">OrderOutput</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># see Lambda timeouts section</span>
    <span class="n">order_item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">order_item</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># `order` parameter must be called as a keyword argument to work</span>
<span class="hll">    <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>We'll use <code>OrderOutput</code> to instantiate a new object using the data retrieved from persistent storage as input. <br><br> This ensures the return of the function is not impacted when <code>@idempotent_function</code> is used.</li>
</ol>
</div>
<div class="tabbed-block">
<p>Alternatively, you can provide an explicit model as an input to <code>DataclassSerializer</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="hll"><span class="p">)</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.serialization.dataclass</span> <span class="kn">import</span> <span class="n">DataclassSerializer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">)</span>  <span class="c1"># see Choosing a payload subset section</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">OrderItem</span><span class="p">:</span>
    <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="n">item</span><span class="p">:</span> <span class="n">OrderItem</span>
    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@dataclass</span>
<span class="hll"><span class="k">class</span> <span class="nc">OrderOutput</span><span class="p">:</span>
</span>    <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span>


<span class="nd">@idempotent_function</span><span class="p">(</span>
    <span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">,</span>
<span class="hll">    <span class="n">output_serializer</span><span class="o">=</span><span class="n">DataclassSerializer</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">OrderOutput</span><span class="p">),</span>
</span><span class="p">)</span>
<span class="hll"><span class="k">def</span> <span class="nf">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">):</span>
</span>    <span class="k">return</span> <span class="n">OrderOutput</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># see Lambda timeouts section</span>
    <span class="n">order_item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">order_item</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># `order` parameter must be called as a keyword argument to work</span>
<span class="hll">    <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<div class="tabbed-block">
<p>Use <code>CustomDictSerializer</code> to have full control over the serialization process for any type. It expects two functions:</p>
<ul>
<li><strong>to_dict</strong>. Function to convert any type to a JSON serializable dictionary before it saves into the persistent storage.</li>
<li><strong>from_dict</strong>. Function to convert from a dictionary retrieved from persistent storage and serialize in its original form.</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Type</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.serialization.custom_dict</span> <span class="kn">import</span> <span class="n">CustomDictSerializer</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">)</span>  <span class="c1"># see Choosing a payload subset section</span>


<span class="k">class</span> <span class="nc">OrderItem</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>


<span class="k">class</span> <span class="nc">Order</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">OrderItem</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">order_id</span>


<span class="k">class</span> <span class="nc">OrderOutput</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_id</span> <span class="o">=</span> <span class="n">order_id</span>


<span class="hll"><span class="k">def</span> <span class="nf">order_to_dict</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">OrderOutput</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>  <span class="c1"># (1)!</span>
</span>    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>


<span class="hll"><span class="k">def</span> <span class="nf">dict_to_order</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderOutput</span><span class="p">:</span>  <span class="c1"># (2)!</span>
</span>    <span class="k">return</span> <span class="n">OrderOutput</span><span class="p">(</span><span class="o">**</span><span class="n">x</span><span class="p">)</span>


<span class="hll"><span class="n">order_output_serializer</span> <span class="o">=</span> <span class="n">CustomDictSerializer</span><span class="p">(</span>  <span class="c1"># (3)!</span>
</span>    <span class="n">to_dict</span><span class="o">=</span><span class="n">order_to_dict</span><span class="p">,</span>
    <span class="n">from_dict</span><span class="o">=</span><span class="n">dict_to_order</span><span class="p">,</span>
<span class="p">)</span>


<span class="nd">@idempotent_function</span><span class="p">(</span>
    <span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">,</span>
<span class="hll">    <span class="n">output_serializer</span><span class="o">=</span><span class="n">order_output_serializer</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="hll"><span class="k">def</span> <span class="nf">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OrderOutput</span><span class="p">:</span>
</span>    <span class="k">return</span> <span class="n">OrderOutput</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">order</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># see Lambda timeouts section</span>
    <span class="n">order_item</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;fake&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Order</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="n">order_item</span><span class="p">,</span> <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># `order` parameter must be called as a keyword argument to work</span>
<span class="hll">    <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>This function does the following <br><br><strong>1</strong>. Receives the return from <code>process_order</code><br> <strong>2</strong>. Converts to dictionary before it can be saved into the persistent storage.</li>
<li>This function does the following <br><br><strong>1</strong>. Receives the dictionary saved into the persistent storage <br><strong>1</strong> Serializes to <code>OrderOutput</code> before <code>@idempotent</code> returns back to the caller.</li>
<li>This serializer receives both functions so it knows who to call when to serialize to and from dictionary.</li>
</ol>
</div>
</div>
</div>
<h3 id="using-in-memory-cache">Using in-memory cache<a class="headerlink" href="#using-in-memory-cache" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">In-memory cache is local to each Lambda execution environment.</p>
</div>
<p>You can enable caching with the <code>use_local_cache</code> parameter in <code>IdempotencyConfig</code>. When enabled, you can adjust cache capacity <em>(256)</em> with <code>local_cache_max_items</code>.</p>
<p>By default, caching is disabled since we don't know how big your response could be in relation to your configured memory size.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="enabling-cache" name="__tabbed_8" type="radio" /><input id="sample-event_1" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="enabling-cache">Enabling cache</label><label for="sample-event_1">Sample event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span>
    <span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;powertools_json(body)&quot;</span><span class="p">,</span>
    <span class="c1"># by default, it holds 256 items in a Least-Recently-Used (LRU) manner</span>
<span class="hll">    <span class="n">use_local_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># (1)!</span>
</span><span class="p">)</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">event</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>You can adjust cache capacity with <a href="#customizing-the-default-behavior"><code>local_cache_max_items</code></a> parameter.</li>
</ol>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;user_id\&quot;:\&quot;xyz\&quot;,\&quot;product_id\&quot;:\&quot;123456789\&quot;}&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="choosing-a-payload-subset">Choosing a payload subset<a class="headerlink" href="#choosing-a-payload-subset" title="Permanent link">&para;</a></h3>
<details class="tip" open="open">
<summary>Tip: Dealing with always changing payloads</summary>
<p>When dealing with a more elaborate payload, where parts of the payload always change, you should use <strong><code>event_key_jmespath</code></strong> parameter.</p>
</details>
<p>Use <strong><code>event_key_jmespath</code></strong> parameter in <a href="#customizing-the-default-behavior"><code>IdempotencyConfig</code></a> to select one or more payload parts as your idempotency key.</p>
<blockquote>
<p><strong>Example scenario</strong></p>
</blockquote>
<p>In this example, we have a Lambda handler that creates a payment for a user subscribing to a product. We want to ensure that we don't accidentally charge our customer by subscribing them more than once.</p>
<p>Imagine the function runs successfully, but the client never receives the response due to a connection issue. It is safe to immediately retry in this instance, as the idempotent decorator will return a previously saved response.</p>
<p>We want to use <code>user_id</code> and <code>product_id</code> fields as our idempotency key. <strong>If we were</strong> to treat the entire request as our idempotency key, a simple HTTP header change would cause our function to run again.</p>
<details class="tip" open="open">
<summary>Deserializing JSON strings in payloads for increased accuracy.</summary>
<p>The payload extracted by the <code>event_key_jmespath</code> is treated as a string by default.
This means there could be differences in whitespace even when the JSON payload itself is identical.</p>
<p>To alter this behaviour, we can use the <a href="../jmespath_functions/#powertools_json-function" target="_blank">JMESPath built-in function</a> <code>powertools_json()</code> to treat the payload as a JSON object (dict) rather than a string.</p>
</details>
<div class="tabbed-set tabbed-alternate" data-tabs="9:2"><input checked="checked" id="payment-function" name="__tabbed_9" type="radio" /><input id="sample-event_2" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="payment-function">Payment function</label><label for="sample-event_2">Sample event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
</span><span class="hll">    <span class="n">IdempotencyConfig</span><span class="p">,</span>
</span><span class="hll">    <span class="n">idempotent</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>

<span class="c1"># Deserialize JSON string under the &quot;body&quot; key</span>
<span class="c1"># then extract &quot;user&quot; and &quot;product_id&quot; data</span>
<span class="hll"><span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s1">&#39;powertools_json(body).[&quot;user_id&quot;, &quot;product_id&quot;]&#39;</span><span class="p">)</span>
</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Payment</span><span class="p">:</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PaymentError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="o">...</span>


<span class="hll"><span class="nd">@idempotent</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payment_info</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">payment</span><span class="p">:</span> <span class="n">Payment</span> <span class="o">=</span> <span class="n">create_subscription_payment</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payment_info</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="n">payment</span><span class="o">.</span><span class="n">payment_id</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PaymentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating payment </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Payment</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Payment</span><span class="p">(</span><span class="o">**</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;routeKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ANY /createpayment&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;rawPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/createpayment&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;rawQueryString&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Header1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Header2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;requestContext&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;accountId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123456789012&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;apiId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;api-id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;domainName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;id.execute-api.us-east-1.amazonaws.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;domainPrefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;http&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/createpayment&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;protocol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HTTP/1.1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;sourceIp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ip&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;userAgent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;agent&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;requestId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;routeKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ANY /createpayment&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$default&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10/Feb/2021:13:40:43 +0000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;timeEpoch&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1612964443723</span>
<span class="w">  </span><span class="p">},</span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;user_id\&quot;:\&quot;xyz\&quot;,\&quot;product_id\&quot;:\&quot;123456789\&quot;}&quot;</span><span class="p">,</span>
</span><span class="w">  </span><span class="nt">&quot;isBase64Encoded&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="adjusting-expiration-window">Adjusting expiration window<a class="headerlink" href="#adjusting-expiration-window" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">By default, we expire idempotency records after <strong>an hour</strong> (3600 seconds). After that, a transaction with the same payload <a href="#expired-idempotency-records">will not be considered idempotent</a>.</p>
</div>
<p>You can change this expiration window with the <strong><code>expires_after_seconds</code></strong> parameter. There is no limit on how long this expiration window can be set to.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:2"><input checked="checked" id="adjusting-expiration-window_1" name="__tabbed_10" type="radio" /><input id="sample-event_3" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="adjusting-expiration-window_1">Adjusting expiration window</label><label for="sample-event_3">Sample event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span>
    <span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;body&quot;</span><span class="p">,</span>
<span class="hll">    <span class="n">expires_after_seconds</span><span class="o">=</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># 24 hours</span>
</span><span class="p">)</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">event</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;user_id\&quot;:\&quot;xyz\&quot;,\&quot;product_id\&quot;:\&quot;123456789\&quot;}&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<details class="important" open="open">
<summary>Idempotency record expiration vs DynamoDB time-to-live (TTL)</summary>
<p><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/howitworks-ttl.html" target="_blank">DynamoDB TTL is a feature</a> to remove items after a certain period of time, it may occur within 48 hours of expiration.</p>
<p>We don't rely on DynamoDB or any persistence storage layer to determine whether a record is expired to avoid eventual inconsistency states.</p>
<p>Instead, Idempotency records saved in the storage layer contain timestamps that can be verified upon retrieval and double checked within Idempotency feature.</p>
<p><strong>Why?</strong></p>
<p>A record might still be valid (<code>COMPLETE</code>) when we retrieved, but in some rare cases it might expire a second later. A record could also be <a href="#using-in-memory-cache">cached in memory</a>. You might also want to have idempotent transactions that should expire in seconds.</p>
</details>
<h3 id="lambda-timeouts">Lambda timeouts<a class="headerlink" href="#lambda-timeouts" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">You can skip this section if you are using the <a href="#idempotent-decorator"><code>@idempotent</code> decorator</a></p>
</div>
<p>By default, we protect against <a href="#handling-concurrent-executions-with-the-same-payload">concurrent executions</a> with the same payload using a locking mechanism. However, if your Lambda function times out before completing the first invocation it will only accept the same request when the <a href="#adjusting-expiration-window">idempotency record expire</a>.</p>
<p>To prevent extended failures, use <strong><code>register_lambda_context</code></strong> function from your idempotency config to calculate and include the remaining invocation time in your idempotency record.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">working_with_lambda_timeout.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.sqs_event</span> <span class="kn">import</span> <span class="n">SQSRecord</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>

<span class="hll"><span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">()</span>
</span>

<span class="nd">@idempotent_function</span><span class="p">(</span><span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;record&quot;</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">]}</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span>
    <span class="k">return</span> <span class="n">record_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<details class="example" open="open">
<summary>Mechanics</summary>
<p>If a second invocation happens <strong>after</strong> this timestamp, and the record is marked as <code>INPROGRESS</code>, we will run the invocation again as if it was in the <code>EXPIRED</code> state.</p>
<p>This means that if an invocation expired during execution, it will be quickly executed again on the next retry.</p>
</details>
<h3 id="handling-exceptions">Handling exceptions<a class="headerlink" href="#handling-exceptions" title="Permanent link">&para;</a></h3>
<p>There are two failure modes that can cause new invocations to execute your code again despite having the same payload:</p>
<ul>
<li><strong>Unhandled exception</strong>. We catch them to delete the idempotency record to prevent inconsistencies, then propagate them.</li>
<li><strong>Persistent layer errors</strong>. We raise <strong><code>IdempotencyPersistenceLayerError</code></strong> for any persistence layer errors <em>e.g., remove idempotency record</em>.</li>
</ul>
<p>If an exception is handled or raised <strong>outside</strong> your decorated function, then idempotency will be maintained.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">working_with_exceptions.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.exceptions</span> <span class="kn">import</span> <span class="n">IdempotencyPersistenceLayerError</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">()</span>


<span class="nd">@idempotent_function</span><span class="p">(</span><span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">call_external_service</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="hll">    <span class="c1"># Any exception raised will lead to idempotency record to be deleted</span>
</span>    <span class="n">result</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;https://jsonplaceholder.typicode.com/comments/&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">call_external_service</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
<span class="hll">    <span class="k">except</span> <span class="n">IdempotencyPersistenceLayerError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span>        <span class="c1"># No idempotency, but you can decide to error differently.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Oops, can&#39;t talk to persistence layer. Permissions? error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># This exception will not impact the idempotency of &#39;call_external_service&#39;</span>
    <span class="c1"># because it happens in isolation, or outside their scope.</span>
<span class="hll">    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;Oops, this shouldn&#39;t be here.&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="persistence-layers">Persistence layers<a class="headerlink" href="#persistence-layers" title="Permanent link">&para;</a></h3>
<h4 id="dynamodbpersistencelayer">DynamoDBPersistenceLayer<a class="headerlink" href="#dynamodbpersistencelayer" title="Permanent link">&para;</a></h4>
<p>This persistence layer is built-in, allowing you to use an existing DynamoDB table or create a new one dedicated to idempotency state (recommended).</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">customize_persistence_layer.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span>
</span><span class="hll">    <span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">,</span>
</span><span class="hll">    <span class="n">key_attr</span><span class="o">=</span><span class="s2">&quot;idempotency_key&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">expiry_attr</span><span class="o">=</span><span class="s2">&quot;expires_at&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">in_progress_expiry_attr</span><span class="o">=</span><span class="s2">&quot;in_progress_expires_at&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">status_attr</span><span class="o">=</span><span class="s2">&quot;current_status&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">data_attr</span><span class="o">=</span><span class="s2">&quot;result_data&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">validation_key_attr</span><span class="o">=</span><span class="s2">&quot;validation_key&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span>

<span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">event</span>
</code></pre></div></td></tr></table></div>
<h5 id="using-a-composite-primary-key">Using a composite primary key<a class="headerlink" href="#using-a-composite-primary-key" title="Permanent link">&para;</a></h5>
<p>Use <code>sort_key_attr</code> parameter when your table is configured with a composite primary key <em>(hash+range key)</em>.</p>
<p>When enabled, we will save the idempotency key in the sort key instead. By default, the primary key will now be set to <code>idempotency#{LAMBDA_FUNCTION_NAME}</code>.</p>
<p>You can optionally set a static value for the partition key using the <code>static_pk_value</code> parameter.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:2"><input checked="checked" id="reusing-a-dynamodb-table-that-uses-a-composite-primary-key" name="__tabbed_11" type="radio" /><input id="sample-event_4" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="reusing-a-dynamodb-table-that-uses-a-composite-primary-key">Reusing a DynamoDB table that uses a composite primary key</label><label for="sample-event_4">Sample Event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">sort_key_attr</span><span class="o">=</span><span class="s2">&quot;sort_key&quot;</span><span class="p">)</span>
</span>

<span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)[</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;user_id\&quot;:\&quot;xyz\&quot;,\&quot;product_id\&quot;:\&quot;123456789\&quot;}&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<details class="note">
<summary>Click to expand and learn how table items would look like</summary>
<table>
<thead>
<tr>
<th>id</th>
<th>sort_key</th>
<th>expiration</th>
<th>status</th>
<th>data</th>
</tr>
</thead>
<tbody>
<tr>
<td>idempotency#MyLambdaFunction</td>
<td>1e956ef7da78d0cb890be999aecc0c9e</td>
<td>1636549553</td>
<td>COMPLETED</td>
<td>{"user_id": 12391, "message": "success"}</td>
</tr>
<tr>
<td>idempotency#MyLambdaFunction</td>
<td>2b2cdb5f86361e97b4383087c1ffdf27</td>
<td>1636549571</td>
<td>COMPLETED</td>
<td>{"user_id": 527212, "message": "success"}</td>
</tr>
<tr>
<td>idempotency#MyLambdaFunction</td>
<td>f091d2527ad1c78f05d54cc3f363be80</td>
<td>1636549585</td>
<td>IN_PROGRESS</td>
<td></td>
</tr>
</tbody>
</table>
</details>
<h5 id="dynamodb-attributes">DynamoDB attributes<a class="headerlink" href="#dynamodb-attributes" title="Permanent link">&para;</a></h5>
<p>You can customize the attribute names during initialization:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>table_name</strong></td>
<td><img alt="âœ”" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2714.svg" title=":heavy_check_mark:" /></td>
<td></td>
<td>Table name to store state</td>
</tr>
<tr>
<td><strong>key_attr</strong></td>
<td></td>
<td><code>id</code></td>
<td>Partition key of the table. Hashed representation of the payload (unless <strong>sort_key_attr</strong> is specified)</td>
</tr>
<tr>
<td><strong>expiry_attr</strong></td>
<td></td>
<td><code>expiration</code></td>
<td>Unix timestamp of when record expires</td>
</tr>
<tr>
<td><strong>in_progress_expiry_attr</strong></td>
<td></td>
<td><code>in_progress_expiration</code></td>
<td>Unix timestamp of when record expires while in progress (in case of the invocation times out)</td>
</tr>
<tr>
<td><strong>status_attr</strong></td>
<td></td>
<td><code>status</code></td>
<td>Stores status of the lambda execution during and after invocation</td>
</tr>
<tr>
<td><strong>data_attr</strong></td>
<td></td>
<td><code>data</code></td>
<td>Stores results of successfully executed Lambda handlers</td>
</tr>
<tr>
<td><strong>validation_key_attr</strong></td>
<td></td>
<td><code>validation</code></td>
<td>Hashed representation of the parts of the event used for validation</td>
</tr>
<tr>
<td><strong>sort_key_attr</strong></td>
<td></td>
<td></td>
<td>Sort key of the table (if table is configured with a sort key).</td>
</tr>
<tr>
<td><strong>static_pk_value</strong></td>
<td></td>
<td><code>idempotency#{LAMBDA_FUNCTION_NAME}</code></td>
<td>Static value to use as the partition key. Only used when <strong>sort_key_attr</strong> is set.</td>
</tr>
</tbody>
</table>
<h4 id="redispersistencelayer">RedisPersistenceLayer<a class="headerlink" href="#redispersistencelayer" title="Permanent link">&para;</a></h4>
<div class="admonition info">
<p class="admonition-title">We recommend Redis version 7 or higher for optimal performance.</p>
</div>
<p>For simple setups, initialize <code>RedisCachePersistenceLayer</code> with your Redis endpoint and port to connect.</p>
<p>For security, we enforce SSL connections by default; to disable it, set <code>ssl=False</code>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="12:3"><input checked="checked" id="redis-quick-start" name="__tabbed_12" type="radio" /><input id="using-an-existing-redis-client" name="__tabbed_12" type="radio" /><input id="sample-event_5" name="__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="redis-quick-start">Redis quick start</label><label for="using-an-existing-redis-client">Using an existing Redis client</label><label for="sample-event_5">Sample event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">getting_started_with_idempotency_redis_config.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.redis</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">RedisCachePersistenceLayer</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">redis_endpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REDIS_CLUSTER_ENDPOINT&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">RedisCachePersistenceLayer</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_endpoint</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Payment</span><span class="p">:</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PaymentError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="o">...</span>


<span class="hll"><span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payment</span><span class="p">:</span> <span class="n">Payment</span> <span class="o">=</span> <span class="n">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="n">payment</span><span class="o">.</span><span class="n">payment_id</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PaymentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating payment </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Payment</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Payment</span><span class="p">(</span><span class="o">**</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">getting_started_with_idempotency_redis_client.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="hll"><span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>
</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.redis</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">RedisCachePersistenceLayer</span><span class="p">,</span>
</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">redis_endpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REDIS_CLUSTER_ENDPOINT&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">client</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span>
</span>    <span class="n">host</span><span class="o">=</span><span class="n">redis_endpoint</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span>
    <span class="n">socket_connect_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">socket_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">max_connections</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>

<span class="hll"><span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">RedisCachePersistenceLayer</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Payment</span><span class="p">:</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PaymentError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="o">...</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="hll"><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="n">payment</span><span class="p">:</span> <span class="n">Payment</span> <span class="o">=</span> <span class="n">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="n">payment</span><span class="o">.</span><span class="n">payment_id</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PaymentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating payment </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Payment</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Payment</span><span class="p">(</span><span class="o">**</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">getting_started_with_idempotency_payload.json</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;product_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123456789&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h5 id="redis-ssl-connections">Redis SSL connections<a class="headerlink" href="#redis-ssl-connections" title="Permanent link">&para;</a></h5>
<p>We recommend using AWS Secrets Manager to store and rotate certificates safely, and the <a href="../parameters/" target="_blank">Parameters feature</a> to fetch and cache optimally.</p>
<p>For advanced configurations, we recommend using an existing Redis client for optimal compatibility like SSL certificates and timeout.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:2"><input checked="checked" id="advanced-configuration-using-aws-secrets" name="__tabbed_13" type="radio" /><input id="advanced-configuration-with-local-certificates" name="__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="advanced-configuration-using-aws-secrets">Advanced configuration using AWS Secrets</label><label for="advanced-configuration-with-local-certificates">Advanced configuration with local certificates</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">using_redis_client_with_aws_secrets.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities</span> <span class="kn">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="n">IdempotencyConfig</span><span class="p">,</span> <span class="n">idempotent</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.redis</span> <span class="kn">import</span> <span class="p">(</span>
</span><span class="hll">    <span class="n">RedisCachePersistenceLayer</span><span class="p">,</span>
</span><span class="hll"><span class="p">)</span>
</span>
<span class="hll"><span class="n">redis_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;redis_info&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>  <span class="c1"># (1)!</span>
</span>
<span class="hll"><span class="n">redis_client</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span>
</span>    <span class="n">host</span><span class="o">=</span><span class="n">redis_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;REDIS_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">),</span>
    <span class="n">port</span><span class="o">=</span><span class="n">redis_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;REDIS_PORT&quot;</span><span class="p">,</span> <span class="mi">6379</span><span class="p">),</span>
    <span class="n">password</span><span class="o">=</span><span class="n">redis_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;REDIS_PASSWORD&quot;</span><span class="p">),</span>
    <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">socket_timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">retry_on_timeout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="hll"><span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">RedisCachePersistenceLayer</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">redis_client</span><span class="p">)</span>
</span><span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span>
    <span class="n">expires_after_seconds</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># 2 minutes</span>
<span class="p">)</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>JSON stored:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="nt">&quot;REDIS_ENDPOINT&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
<span class="nt">&quot;REDIS_PORT&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6379&quot;</span><span class="p">,</span>
<span class="nt">&quot;REDIS_PASSWORD&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;redis-secret&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></li>
</ol>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">using_redis_client_with_local_certs.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.shared.functions</span> <span class="kn">import</span> <span class="n">abs_lambda_path</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities</span> <span class="kn">import</span> <span class="n">parameters</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="n">IdempotencyConfig</span><span class="p">,</span> <span class="n">idempotent</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.redis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RedisCachePersistenceLayer</span><span class="p">,</span>
<span class="p">)</span>

<span class="hll"><span class="n">redis_values</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="s2">&quot;redis_info&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>  <span class="c1"># (1)!</span>
</span>

<span class="n">redis_client</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="n">redis_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;REDIS_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">),</span>
    <span class="n">port</span><span class="o">=</span><span class="n">redis_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;REDIS_PORT&quot;</span><span class="p">,</span> <span class="mi">6379</span><span class="p">),</span>
    <span class="n">password</span><span class="o">=</span><span class="n">redis_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;REDIS_PASSWORD&quot;</span><span class="p">),</span>
    <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">socket_timeout</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">retry_on_timeout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="hll">    <span class="n">ssl_certfile</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abs_lambda_path</span><span class="p">()</span><span class="si">}</span><span class="s2">/certs/redis_user.crt&quot;</span><span class="p">,</span>  <span class="c1"># (2)!</span>
</span><span class="hll">    <span class="n">ssl_keyfile</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abs_lambda_path</span><span class="p">()</span><span class="si">}</span><span class="s2">/certs/redis_user_private.key&quot;</span><span class="p">,</span>  <span class="c1"># (3)!</span>
</span><span class="hll">    <span class="n">ssl_ca_certs</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">abs_lambda_path</span><span class="p">()</span><span class="si">}</span><span class="s2">/certs/redis_ca.pem&quot;</span><span class="p">,</span>  <span class="c1"># (4)!</span>
</span><span class="p">)</span>

<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">RedisCachePersistenceLayer</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">redis_client</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span>
    <span class="n">expires_after_seconds</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>  <span class="c1"># 2 minutes</span>
<span class="p">)</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>JSON stored:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="nt">&quot;REDIS_ENDPOINT&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
<span class="nt">&quot;REDIS_PORT&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6379&quot;</span><span class="p">,</span>
<span class="nt">&quot;REDIS_PASSWORD&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;redis-secret&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div></li>
<li>redis_user.crt file stored in the "certs" directory of your Lambda function</li>
<li>redis_user_private.key file stored in the "certs" directory of your Lambda function</li>
<li>redis_ca.pem file stored in the "certs" directory of your Lambda function</li>
</ol>
</div>
</div>
</div>
<h5 id="redis-attributes">Redis attributes<a class="headerlink" href="#redis-attributes" title="Permanent link">&para;</a></h5>
<p>You can customize the attribute names during initialization:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>in_progress_expiry_attr</strong></td>
<td></td>
<td><code>in_progress_expiration</code></td>
<td>Unix timestamp of when record expires while in progress (in case of the invocation times out)</td>
</tr>
<tr>
<td><strong>status_attr</strong></td>
<td></td>
<td><code>status</code></td>
<td>Stores status of the Lambda execution during and after invocation</td>
</tr>
<tr>
<td><strong>data_attr</strong></td>
<td></td>
<td><code>data</code></td>
<td>Stores results of successfully executed Lambda handlers</td>
</tr>
<tr>
<td><strong>validation_key_attr</strong></td>
<td></td>
<td><code>validation</code></td>
<td>Hashed representation of the parts of the event used for validation</td>
</tr>
</tbody>
</table>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">customize_persistence_layer_redis.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.redis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RedisCachePersistenceLayer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">redis_endpoint</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;REDIS_CLUSTER_ENDPOINT&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">RedisCachePersistenceLayer</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="n">redis_endpoint</span><span class="p">,</span>
    <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span>
<span class="hll">    <span class="n">in_progress_expiry_attr</span><span class="o">=</span><span class="s2">&quot;in_progress_expiration&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">status_attr</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">data_attr</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
</span><span class="hll">    <span class="n">validation_key_attr</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">,</span>
</span><span class="p">)</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">event</span>
</code></pre></div></td></tr></table></div>
<h3 id="common-use-cases">Common use cases<a class="headerlink" href="#common-use-cases" title="Permanent link">&para;</a></h3>
<h4 id="batch-processing">Batch processing<a class="headerlink" href="#batch-processing" title="Permanent link">&para;</a></h4>
<p>You can can easily integrate with <a href="../batch/" target="_blank">Batch</a> using the <a href="#idempotent_function-decorator">idempotent_function decorator</a> to handle idempotency per message/record in a given batch.</p>
<details open="open">
<summary>Choosing an unique batch record attribute</summary>
<p>In this example, we choose <code>messageId</code> as our idempotency key since we know it'll be unique.</p>
<p>Depending on your use case, it might be more accurate <a href="#choosing-a-payload-subset">to choose another field</a> your producer intentionally set to define uniqueness.</p>
</details>
<div class="tabbed-set tabbed-alternate" data-tabs="14:2"><input checked="checked" id="integration-with-batch-processor" name="__tabbed_14" type="radio" /><input id="sample-event_6" name="__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="integration-with-batch-processor">Integration with Batch Processor</label><label for="sample-event_6">Sample event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">integrate_idempotency_with_batch_processor.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="hll">
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">process_partial_response</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.sqs_event</span> <span class="kn">import</span> <span class="n">SQSRecord</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
</span><span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;messageId&quot;</span><span class="p">)</span>

<span class="hll">
</span><span class="nd">@idempotent_function</span><span class="p">(</span><span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;record&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span><span class="p">}</span>


<span class="hll"><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
</span>    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># see Lambda timeouts section</span>
<span class="hll">
</span>    <span class="k">return</span> <span class="n">process_partial_response</span><span class="p">(</span>
        <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
        <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">,</span>
        <span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">integrate_idempotency_with_batch_processor_payload.json</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;Records&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="hll"><span class="w">      </span><span class="nt">&quot;messageId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;059f36b4-87a3-44ab-83d2-661975830a7d&quot;</span><span class="p">,</span>
</span><span class="w">      </span><span class="nt">&quot;receiptHandle&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AQEBwJnKyrHigUMZj6rYigCgxlaS3SLy0a...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Test message.&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;ApproximateReceiveCount&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;SentTimestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1545082649183&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;SenderId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;replace-to-pass-gitleak&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;ApproximateFirstReceiveTimestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1545082649185&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;messageAttributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;testAttr&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;stringValue&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;binaryValue&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;base64Str&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;dataType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Number&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;md5OfBody&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;e4e68fb7bd0e697a0ae8f1bb342846b3&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;eventSource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aws:sqs&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:sqs:us-east-2:123456789012:my-queue&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;us-east-2&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="idempotency-request-flow">Idempotency request flow<a class="headerlink" href="#idempotency-request-flow" title="Permanent link">&para;</a></h3>
<p>The following sequence diagrams explain how the Idempotency feature behaves under different scenarios.</p>
<h4 id="successful-request">Successful request<a class="headerlink" href="#successful-request" title="Permanent link">&para;</a></h4>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    alt initial request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Note over Lambda,Persistence Layer: Set record status to INPROGRESS. &lt;br&gt; Prevents concurrent invocations &lt;br&gt; with the same payload
        Lambda--&gt;&gt;Lambda: Call your function
        Lambda-&gt;&gt;Persistence Layer: Update record with result
        deactivate Persistence Layer
        Persistence Layer--&gt;&gt;Persistence Layer: Update record
        Note over Lambda,Persistence Layer: Set record status to COMPLETE. &lt;br&gt; New invocations with the same payload &lt;br&gt; now return the same result
        Lambda--&gt;&gt;Client: Response sent to client
    else retried request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Persistence Layer--&gt;&gt;Lambda: Already exists in persistence layer.
        deactivate Persistence Layer
        Note over Lambda,Persistence Layer: Record status is COMPLETE and not expired
        Lambda--&gt;&gt;Client: Same response sent to client
    end</code></pre>
<i>Idempotent successful request</i>
</center></p>
<h4 id="successful-request-with-cache-enabled">Successful request with cache enabled<a class="headerlink" href="#successful-request-with-cache-enabled" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title"><a href="#using-in-memory-cache">In-memory cache is disabled by default</a>.</p>
</div>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    alt initial request
      Client-&gt;&gt;Lambda: Invoke (event)
      Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
      activate Persistence Layer
      Note over Lambda,Persistence Layer: Set record status to INPROGRESS. &lt;br&gt; Prevents concurrent invocations &lt;br&gt; with the same payload
      Lambda--&gt;&gt;Lambda: Call your function
      Lambda-&gt;&gt;Persistence Layer: Update record with result
      deactivate Persistence Layer
      Persistence Layer--&gt;&gt;Persistence Layer: Update record
      Note over Lambda,Persistence Layer: Set record status to COMPLETE. &lt;br&gt; New invocations with the same payload &lt;br&gt; now return the same result
      Lambda--&gt;&gt;Lambda: Save record and result in memory
      Lambda--&gt;&gt;Client: Response sent to client
    else retried request
      Client-&gt;&gt;Lambda: Invoke (event)
      Lambda--&gt;&gt;Lambda: Get idempotency_key=hash(payload)
      Note over Lambda,Persistence Layer: Record status is COMPLETE and not expired
      Lambda--&gt;&gt;Client: Same response sent to client
    end</code></pre>
<i>Idempotent successful request cached</i>
</center></p>
<h4 id="successful-request-with-response_hook-configured">Successful request with response_hook configured<a class="headerlink" href="#successful-request-with-response_hook-configured" title="Permanent link">&para;</a></h4>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Response hook
    participant Persistence Layer
    alt initial request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Note over Lambda,Persistence Layer: Set record status to INPROGRESS. &lt;br&gt; Prevents concurrent invocations &lt;br&gt; with the same payload
        Lambda--&gt;&gt;Lambda: Call your function
        Lambda-&gt;&gt;Persistence Layer: Update record with result
        deactivate Persistence Layer
        Persistence Layer--&gt;&gt;Persistence Layer: Update record
        Note over Lambda,Persistence Layer: Set record status to COMPLETE. &lt;br&gt; New invocations with the same payload &lt;br&gt; now return the same result
        Lambda--&gt;&gt;Client: Response sent to client
    else retried request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Persistence Layer--&gt;&gt;Response hook: Already exists in persistence layer.
        deactivate Persistence Layer
        Note over Response hook,Persistence Layer: Record status is COMPLETE and not expired
        Response hook-&gt;&gt;Lambda: Response hook invoked
        Lambda--&gt;&gt;Client: Manipulated idempotent response sent to client
    end</code></pre>
<i>Successful idempotent request with a response hook</i>
</center></p>
<h4 id="expired-idempotency-records">Expired idempotency records<a class="headerlink" href="#expired-idempotency-records" title="Permanent link">&para;</a></h4>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    alt initial request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Note over Lambda,Persistence Layer: Set record status to INPROGRESS. &lt;br&gt; Prevents concurrent invocations &lt;br&gt; with the same payload
        Lambda--&gt;&gt;Lambda: Call your function
        Lambda-&gt;&gt;Persistence Layer: Update record with result
        deactivate Persistence Layer
        Persistence Layer--&gt;&gt;Persistence Layer: Update record
        Note over Lambda,Persistence Layer: Set record status to COMPLETE. &lt;br&gt; New invocations with the same payload &lt;br&gt; now return the same result
        Lambda--&gt;&gt;Client: Response sent to client
    else retried request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Persistence Layer--&gt;&gt;Lambda: Already exists in persistence layer.
        deactivate Persistence Layer
        Note over Lambda,Persistence Layer: Record status is COMPLETE but expired hours ago
        loop Repeat initial request process
            Note over Lambda,Persistence Layer: 1. Set record to INPROGRESS, &lt;br&gt; 2. Call your function, &lt;br&gt; 3. Set record to COMPLETE
        end
        Lambda--&gt;&gt;Client: Same response sent to client
    end</code></pre>
<i>Previous Idempotent request expired</i>
</center></p>
<h4 id="concurrent-identical-in-flight-requests">Concurrent identical in-flight requests<a class="headerlink" href="#concurrent-identical-in-flight-requests" title="Permanent link">&para;</a></h4>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    Client-&gt;&gt;Lambda: Invoke (event)
    Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
    activate Persistence Layer
    Note over Lambda,Persistence Layer: Set record status to INPROGRESS. &lt;br&gt; Prevents concurrent invocations &lt;br&gt; with the same payload
      par Second request
          Client-&gt;&gt;Lambda: Invoke (event)
          Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
          Lambda--xLambda: IdempotencyAlreadyInProgressError
          Lambda-&gt;&gt;Client: Error sent to client if unhandled
      end
    Lambda--&gt;&gt;Lambda: Call your function
    Lambda-&gt;&gt;Persistence Layer: Update record with result
    deactivate Persistence Layer
    Persistence Layer--&gt;&gt;Persistence Layer: Update record
    Note over Lambda,Persistence Layer: Set record status to COMPLETE. &lt;br&gt; New invocations with the same payload &lt;br&gt; now return the same result
    Lambda--&gt;&gt;Client: Response sent to client</code></pre>
<i>Concurrent identical in-flight requests</i>
</center></p>
<h4 id="unhandled-exception">Unhandled exception<a class="headerlink" href="#unhandled-exception" title="Permanent link">&para;</a></h4>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    Client-&gt;&gt;Lambda: Invoke (event)
    Lambda-&gt;&gt;Persistence Layer: Get or set (id=event.search(payload))
    activate Persistence Layer
    Note right of Persistence Layer: Locked during this time. Prevents multiple&lt;br/&gt;Lambda invocations with the same&lt;br/&gt;payload running concurrently.
    Lambda--xLambda: Call handler (event).&lt;br/&gt;Raises exception
    Lambda-&gt;&gt;Persistence Layer: Delete record (id=event.search(payload))
    deactivate Persistence Layer
    Lambda--&gt;&gt;Client: Return error response</code></pre>
<i>Idempotent sequence exception</i>
</center></p>
<h4 id="lambda-request-timeout">Lambda request timeout<a class="headerlink" href="#lambda-request-timeout" title="Permanent link">&para;</a></h4>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    alt initial request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Note over Lambda,Persistence Layer: Set record status to INPROGRESS. &lt;br&gt; Prevents concurrent invocations &lt;br&gt; with the same payload
        Lambda--&gt;&gt;Lambda: Call your function
        Note right of Lambda: Time out
        Lambda--xLambda: Time out error
        Lambda--&gt;&gt;Client: Return error response
        deactivate Persistence Layer
    else retry after Lambda timeout elapses
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Note over Lambda,Persistence Layer: Set record status to INPROGRESS. &lt;br&gt; Reset in_progress_expiry attribute
        Lambda--&gt;&gt;Lambda: Call your function
        Lambda-&gt;&gt;Persistence Layer: Update record with result
        deactivate Persistence Layer
        Persistence Layer--&gt;&gt;Persistence Layer: Update record
        Lambda--&gt;&gt;Client: Response sent to client
    end</code></pre>
<i>Idempotent request during and after Lambda timeouts</i>
</center></p>
<h4 id="optional-idempotency-key">Optional idempotency key<a class="headerlink" href="#optional-idempotency-key" title="Permanent link">&para;</a></h4>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    alt request with idempotency key
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set idempotency_key=hash(payload)
        activate Persistence Layer
        Note over Lambda,Persistence Layer: Set record status to INPROGRESS. &lt;br&gt; Prevents concurrent invocations &lt;br&gt; with the same payload
        Lambda--&gt;&gt;Lambda: Call your function
        Lambda-&gt;&gt;Persistence Layer: Update record with result
        deactivate Persistence Layer
        Persistence Layer--&gt;&gt;Persistence Layer: Update record
        Note over Lambda,Persistence Layer: Set record status to COMPLETE. &lt;br&gt; New invocations with the same payload &lt;br&gt; now return the same result
        Lambda--&gt;&gt;Client: Response sent to client
    else request(s) without idempotency key
        Client-&gt;&gt;Lambda: Invoke (event)
        Note over Lambda: Idempotency key is missing
        Note over Persistence Layer: Skips any operation to fetch, update, and delete
        Lambda--&gt;&gt;Lambda: Call your function
        Lambda--&gt;&gt;Client: Response sent to client
    end</code></pre>
<i>Optional idempotency key</i>
</center></p>
<h4 id="race-condition-with-redis">Race condition with Redis<a class="headerlink" href="#race-condition-with-redis" title="Permanent link">&para;</a></h4>
<p><center>
<pre class="mermaid"><code>graph TD;
    A(Existing orphan record in redis)--&gt;A1;
    A1[Two Lambda invoke at same time]--&gt;B1[Lambda handler1];
    B1--&gt;B2[Fetch from Redis];
    B2--&gt;B3[Handler1 got orphan record];
    B3--&gt;B4[Handler1 acquired lock];
    B4--&gt;B5[Handler1 overwrite orphan record]
    B5--&gt;B6[Handler1 continue to execution];
    A1--&gt;C1[Lambda handler2];
    C1--&gt;C2[Fetch from Redis];
    C2--&gt;C3[Handler2 got orphan record];
    C3--&gt;C4[Handler2 failed to acquire lock];
    C4--&gt;C5[Handler2 wait and fetch from Redis];
    C5--&gt;C6[Handler2 return without executing];
    B6--&gt;D(Lambda handler executed only once);
    C6--&gt;D;</code></pre>
<i>Race condition with Redis</i>
</center></p>
<h2 id="advanced">Advanced<a class="headerlink" href="#advanced" title="Permanent link">&para;</a></h2>
<h3 id="customizing-the-default-behavior">Customizing the default behavior<a class="headerlink" href="#customizing-the-default-behavior" title="Permanent link">&para;</a></h3>
<p>You can override and further extend idempotency behavior via <strong><code>IdempotencyConfig</code></strong> with the following options:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>event_key_jmespath</strong></td>
<td><code>""</code></td>
<td>JMESPath expression to extract the idempotency key from the event record using <a href="../jmespath_functions/#built-in-jmespath-functions" target="_blank">built-in functions</a></td>
</tr>
<tr>
<td><strong>payload_validation_jmespath</strong></td>
<td><code>""</code></td>
<td>JMESPath expression to validate that the specified fields haven't changed across requests for the same idempotency key <em>e.g., payload tampering.</em></td>
</tr>
<tr>
<td><strong>raise_on_no_idempotency_key</strong></td>
<td><code>False</code></td>
<td>Raise exception if no idempotency key was found in the request</td>
</tr>
<tr>
<td><strong>expires_after_seconds</strong></td>
<td>3600</td>
<td>The number of seconds to wait before a record is expired, allowing a new transaction with the same idempotency key</td>
</tr>
<tr>
<td><strong>use_local_cache</strong></td>
<td><code>False</code></td>
<td>Whether to cache idempotency results in-memory to save on persistence storage latency and costs</td>
</tr>
<tr>
<td><strong>local_cache_max_items</strong></td>
<td>256</td>
<td>Max number of items to store in local cache</td>
</tr>
<tr>
<td><strong>hash_function</strong></td>
<td><code>md5</code></td>
<td>Function to use for calculating hashes, as provided by <a href="https://docs.python.org/3/library/hashlib.html" rel="nofollow" target="_blank">hashlib</a> in the standard library.</td>
</tr>
<tr>
<td><strong>response_hook</strong></td>
<td><code>None</code></td>
<td>Function to use for processing the stored Idempotent response. This function hook is called when an existing idempotent response is found. See <a href="./#manipulating-the-idempotent-response">Manipulating The Idempotent Response</a></td>
</tr>
</tbody>
</table>
<h3 id="handling-concurrent-executions-with-the-same-payload">Handling concurrent executions with the same payload<a class="headerlink" href="#handling-concurrent-executions-with-the-same-payload" title="Permanent link">&para;</a></h3>
<p>This utility will raise an <strong><code>IdempotencyAlreadyInProgressError</code></strong> exception if you receive <strong>multiple invocations with the same payload while the first invocation hasn't completed yet</strong>.</p>
<details class="info" open="open">
<summary>Info</summary>
<p>If you receive <code>IdempotencyAlreadyInProgressError</code>, you can safely retry the operation.</p>
</details>
<p>This is a locking mechanism for correctness. Since we don't know the result from the first invocation yet, we can't safely allow another concurrent execution.</p>
<h3 id="payload-validation">Payload validation<a class="headerlink" href="#payload-validation" title="Permanent link">&para;</a></h3>
<details class="question" open="open">
<summary>Question: What if your function is invoked with the same payload except some outer parameters have changed?</summary>
<p>Example: A payment transaction for a given productID was requested twice for the same customer, <strong>however the amount to be paid has changed in the second transaction</strong>.</p>
</details>
<p>By default, we will return the same result as it returned before, however in this instance it may be misleading; we provide a fail fast payload validation to address this edge case.</p>
<p>With <strong><code>payload_validation_jmespath</code></strong>, you can provide an additional JMESPath expression to specify which part of the event body should be validated against previous idempotent invocations</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:3"><input checked="checked" id="payload-validation_1" name="__tabbed_15" type="radio" /><input id="sample-event-1" name="__tabbed_15" type="radio" /><input id="sample-event-2" name="__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="payload-validation_1">Payload validation</label><label for="sample-event-1">Sample event 1</label><label for="sample-event-2">Sample event 2</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.exceptions</span> <span class="kn">import</span> <span class="n">IdempotencyValidationError</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span>
    <span class="n">event_key_jmespath</span><span class="o">=</span><span class="s1">&#39;[&quot;user_id&quot;, &quot;product_id&quot;]&#39;</span><span class="p">,</span>
<span class="hll">    <span class="n">payload_validation_jmespath</span><span class="o">=</span><span class="s2">&quot;amount&quot;</span><span class="p">,</span>
</span><span class="p">)</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Payment</span><span class="p">:</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">product_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">charge_type</span><span class="p">:</span> <span class="nb">str</span>
<span class="hll">    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span>
</span>    <span class="n">payment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PaymentError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="o">...</span>


<span class="hll"><span class="nd">@idempotent</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">payment</span><span class="p">:</span> <span class="n">Payment</span> <span class="o">=</span> <span class="n">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="n">payment</span><span class="o">.</span><span class="n">payment_id</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="n">IdempotencyValidationError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Payload tampering detected&quot;</span><span class="p">,</span> <span class="n">payment</span><span class="o">=</span><span class="n">payment</span><span class="p">,</span> <span class="n">failure_type</span><span class="o">=</span><span class="s2">&quot;validation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Unable to process payment at this time. Try again later.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PaymentError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating payment </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_subscription_payment</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Payment</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Payment</span><span class="p">(</span><span class="o">**</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span class="w">  </span><span class="nt">&quot;product_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1500</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;charge_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;subscription&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
</span><span class="w">  </span><span class="nt">&quot;product_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1500</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;charge_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;subscription&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>In this example, the <strong><code>user_id</code></strong> and <strong><code>product_id</code></strong> keys are used as the payload to generate the idempotency key, as per <strong><code>event_key_jmespath</code></strong> parameter.</p>
<details class="note" open="open">
<summary>Note</summary>
<p>If we try to send the same request but with a different amount, we will raise <strong><code>IdempotencyValidationError</code></strong>.</p>
</details>
<p>Without payload validation, we would have returned the same result as we did for the initial request. Since we're also returning an amount in the response, this could be quite confusing for the client.</p>
<p>By using <strong><code>payload_validation_jmespath="amount"</code></strong>, we prevent this potentially confusing behavior and instead raise an Exception.</p>
<h3 id="making-idempotency-key-required">Making idempotency key required<a class="headerlink" href="#making-idempotency-key-required" title="Permanent link">&para;</a></h3>
<p>If you want to enforce that an idempotency key is required, you can set <strong><code>raise_on_no_idempotency_key</code></strong> to <code>True</code>.</p>
<p>This means that we will raise <strong><code>IdempotencyKeyError</code></strong> if the evaluation of <strong><code>event_key_jmespath</code></strong> is <code>None</code>.</p>
<details class="warning" open="open">
<summary>Warning</summary>
<p>To prevent errors, transactions will not be treated as idempotent if <strong><code>raise_on_no_idempotency_key</code></strong> is set to <code>False</code> and the evaluation of <strong><code>event_key_jmespath</code></strong> is <code>None</code>. Therefore, no data will be fetched, stored, or deleted in the idempotency storage layer.</p>
</details>
<div class="tabbed-set tabbed-alternate" data-tabs="16:3"><input checked="checked" id="idempotency-key-required" name="__tabbed_16" type="radio" /><input id="success-event" name="__tabbed_16" type="radio" /><input id="failure-event" name="__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="idempotency-key-required">Idempotency key required</label><label for="success-event">Success Event</label><label for="failure-event">Failure Event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span>
    <span class="n">event_key_jmespath</span><span class="o">=</span><span class="s1">&#39;[&quot;user.uid&quot;, &quot;order_id&quot;]&#39;</span><span class="p">,</span>
<span class="hll">    <span class="n">raise_on_no_idempotency_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span class="p">)</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">event</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BB0D045C-8878-40C8-889E-38B3CB0A61B1&quot;</span><span class="p">,</span>
</span><span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Foo&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;order_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BB0D045C-8878-40C8-889E-38B3CB0A61B1&quot;</span><span class="p">,</span>
</span><span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Foo&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;order_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span>
</span><span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="customizing-boto-configuration">Customizing boto configuration<a class="headerlink" href="#customizing-boto-configuration" title="Permanent link">&para;</a></h3>
<!-- markdownlint-disable-next-line MD013 -->
<p>The <strong><code>boto_config</code></strong> and <strong><code>boto3_session</code></strong> parameters enable you to pass in a custom <a href="https://botocore.amazonaws.com/v1/documentation/api/latest/reference/config.html" target="_blank">botocore config object</a> or a custom <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/core/session.html" target="_blank">boto3 session</a> when constructing the persistence store.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="17:3"><input checked="checked" id="custom-session" name="__tabbed_17" type="radio" /><input id="custom-config" name="__tabbed_17" type="radio" /><input id="sample-event_7" name="__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="custom-session">Custom session</label><label for="custom-config">Custom config</label><label for="sample-event_7">Sample Event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="hll"><span class="kn">import</span> <span class="nn">boto3</span>
</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="c1"># See: https://boto3.amazonaws.com/v1/documentation/api/latest/reference/core/session.html#module-boto3.session</span>
<span class="hll"><span class="n">boto3_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">boto3_session</span><span class="o">=</span><span class="n">boto3_session</span><span class="p">)</span>
</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">event</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="hll"><span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span>
</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="c1"># See: https://botocore.amazonaws.com/v1/documentation/api/latest/reference/config.html#botocore-config</span>
<span class="hll"><span class="n">boto_config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="hll"><span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">boto_config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>


<span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">event</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;user_id\&quot;:\&quot;xyz\&quot;,\&quot;product_id\&quot;:\&quot;123456789\&quot;}&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="bring-your-own-persistent-store">Bring your own persistent store<a class="headerlink" href="#bring-your-own-persistent-store" title="Permanent link">&para;</a></h3>
<p>This utility provides an abstract base class (ABC), so that you can implement your choice of persistent storage layer.</p>
<p>You can create your own persistent store from scratch by inheriting the <code>BasePersistenceLayer</code> class, and implementing <code>_get_record()</code>, <code>_put_record()</code>, <code>_update_record()</code> and <code>_delete_record()</code>.</p>
<ul>
<li><strong><code>_get_record()</code></strong> â€“ Retrieves an item from the persistence store using an idempotency key and returns it as a <code>DataRecord</code> instance.</li>
<li><strong><code>_put_record()</code></strong> â€“ Adds a <code>DataRecord</code> to the persistence store if it doesn't already exist with that key. Raises an <code>ItemAlreadyExists</code> exception if a non-expired entry already exists.</li>
<li><strong><code>_update_record()</code></strong> â€“ Updates an item in the persistence store.</li>
<li><strong><code>_delete_record()</code></strong> â€“ Removes an item from the persistence store.</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">bring_your_own_persistent_store.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="n">BasePersistenceLayer</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IdempotencyItemAlreadyExistsError</span><span class="p">,</span>
    <span class="n">IdempotencyItemNotFoundError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.base</span> <span class="kn">import</span> <span class="n">DataRecord</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="hll"><span class="k">class</span> <span class="nc">MyOwnPersistenceLayer</span><span class="p">(</span><span class="n">BasePersistenceLayer</span><span class="p">):</span>
</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">key_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="n">expiry_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;expiration&quot;</span><span class="p">,</span>
        <span class="n">status_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span>
        <span class="n">data_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
        <span class="n">validation_key_attr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;validation&quot;</span><span class="p">,</span>
        <span class="n">boto_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">boto3_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">boto3_session</span> <span class="o">=</span> <span class="n">boto3_session</span> <span class="ow">or</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddb_resource</span> <span class="o">=</span> <span class="n">boto3_session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">boto_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddb_resource</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_attr</span> <span class="o">=</span> <span class="n">key_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expiry_attr</span> <span class="o">=</span> <span class="n">expiry_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_attr</span> <span class="o">=</span> <span class="n">status_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_attr</span> <span class="o">=</span> <span class="n">data_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_key_attr</span> <span class="o">=</span> <span class="n">validation_key_attr</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_item_to_data_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataRecord</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translate raw item records from DynamoDB to DataRecord</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        item: Dict[str, Union[str, int]]</span>
<span class="sd">                Item format from dynamodb response</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataRecord</span>
<span class="sd">                representation of item</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">DataRecord</span><span class="p">(</span>
            <span class="n">idempotency_key</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key_attr</span><span class="p">],</span>
            <span class="n">status</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status_attr</span><span class="p">],</span>
            <span class="n">expiry_timestamp</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">expiry_attr</span><span class="p">],</span>
            <span class="n">response_data</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_attr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">payload_hash</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_key_attr</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idempotency_key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataRecord</span><span class="p">:</span>
<span class="hll">        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key_attr</span><span class="p">:</span> <span class="n">idempotency_key</span><span class="p">},</span> <span class="n">ConsistentRead</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Item&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IdempotencyItemNotFoundError</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_item_to_data_record</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_put_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_record</span><span class="p">:</span> <span class="n">DataRecord</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="hll">        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
</span>            <span class="bp">self</span><span class="o">.</span><span class="n">key_attr</span><span class="p">:</span> <span class="n">data_record</span><span class="o">.</span><span class="n">idempotency_key</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expiry_attr</span><span class="p">:</span> <span class="n">data_record</span><span class="o">.</span><span class="n">expiry_timestamp</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_attr</span><span class="p">:</span> <span class="n">data_record</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload_validation_enabled</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_key_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_record</span><span class="o">.</span><span class="n">payload_hash</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Putting record for idempotency key: </span><span class="si">{</span><span class="n">data_record</span><span class="o">.</span><span class="n">idempotency_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
                <span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span>
                <span class="n">ConditionExpression</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;attribute_not_exists(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key_attr</span><span class="si">}</span><span class="s2">) OR </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">expiry_attr</span><span class="si">}</span><span class="s2"> &lt; :now&quot;</span><span class="p">,</span>
                <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;:now&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())},</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddb_resource</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConditionalCheckFailedException</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to put record for already existing idempotency key: </span><span class="si">{</span><span class="n">data_record</span><span class="o">.</span><span class="n">idempotency_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">IdempotencyItemAlreadyExistsError</span>

    <span class="k">def</span> <span class="nf">_update_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_record</span><span class="p">:</span> <span class="n">DataRecord</span><span class="p">):</span>
<span class="hll">        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating record for idempotency key: </span><span class="si">{</span><span class="n">data_record</span><span class="o">.</span><span class="n">idempotency_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span>        <span class="n">update_expression</span> <span class="o">=</span> <span class="s2">&quot;SET #response_data = :response_data, #expiry = :expiry, #status = :status&quot;</span>
        <span class="n">expression_attr_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;:expiry&quot;</span><span class="p">:</span> <span class="n">data_record</span><span class="o">.</span><span class="n">expiry_timestamp</span><span class="p">,</span>
            <span class="s2">&quot;:response_data&quot;</span><span class="p">:</span> <span class="n">data_record</span><span class="o">.</span><span class="n">response_data</span><span class="p">,</span>
            <span class="s2">&quot;:status&quot;</span><span class="p">:</span> <span class="n">data_record</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">expression_attr_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;#response_data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_attr</span><span class="p">,</span>
            <span class="s2">&quot;#expiry&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">expiry_attr</span><span class="p">,</span>
            <span class="s2">&quot;#status&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_attr</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload_validation_enabled</span><span class="p">:</span>
            <span class="n">update_expression</span> <span class="o">+=</span> <span class="s2">&quot;, #validation_key = :validation_key&quot;</span>
            <span class="n">expression_attr_values</span><span class="p">[</span><span class="s2">&quot;:validation_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_record</span><span class="o">.</span><span class="n">payload_hash</span>
            <span class="n">expression_attr_names</span><span class="p">[</span><span class="s2">&quot;#validation_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_key_attr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
            <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key_attr</span><span class="p">:</span> <span class="n">data_record</span><span class="o">.</span><span class="n">idempotency_key</span><span class="p">},</span>
            <span class="n">UpdateExpression</span><span class="o">=</span><span class="n">update_expression</span><span class="p">,</span>
            <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="n">expression_attr_values</span><span class="p">,</span>
            <span class="n">ExpressionAttributeNames</span><span class="o">=</span><span class="n">expression_attr_names</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_delete_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_record</span><span class="p">:</span> <span class="n">DataRecord</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting record for idempotency key: </span><span class="si">{</span><span class="n">data_record</span><span class="o">.</span><span class="n">idempotency_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">delete_item</span><span class="p">(</span>
<span class="hll">            <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key_attr</span><span class="p">:</span> <span class="n">data_record</span><span class="o">.</span><span class="n">idempotency_key</span><span class="p">},</span>
</span>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
<details class="danger" open="open">
<summary>Danger</summary>
<p>Pay attention to the documentation for each - you may need to perform additional checks inside these methods to ensure the idempotency guarantees remain intact.</p>
<p>For example, the <code>_put_record</code> method needs to raise an exception if a non-expired record already exists in the data store with a matching key.</p>
</details>
<h3 id="manipulating-the-idempotent-response">Manipulating the Idempotent Response<a class="headerlink" href="#manipulating-the-idempotent-response" title="Permanent link">&para;</a></h3>
<p>You can set up a <code>response_hook</code> in the <code>IdempotentConfig</code> class to manipulate the returned data when an operation is idempotent. The hook function will be called with the current deserialized response object and the Idempotency record.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="18:2"><input checked="checked" id="using-an-idempotent-response-hook" name="__tabbed_18" type="radio" /><input id="sample-event_8" name="__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="using-an-idempotent-response-hook">Using an Idempotent Response Hook</label><label for="sample-event_8">Sample event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent_function</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.datarecord</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DataRecord</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">my_response_hook</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">idempotent_data</span><span class="p">:</span> <span class="n">DataRecord</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="hll">    <span class="c1"># Return inserted Header data into the Idempotent Response</span>
</span>    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;x-idempotent-key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idempotent_data</span><span class="o">.</span><span class="n">idempotency_key</span>
<span class="hll">
</span>    <span class="c1"># expiry_timestamp can be None so include if set</span>
    <span class="n">expiry_timestamp</span> <span class="o">=</span> <span class="n">idempotent_data</span><span class="o">.</span><span class="n">get_expiration_datetime</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">expiry_timestamp</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;x-idempotent-expiration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expiry_timestamp</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

<span class="hll">    <span class="c1"># Must return the response here</span>
</span>    <span class="k">return</span> <span class="n">response</span>


<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">response_hook</span><span class="o">=</span><span class="n">my_response_hook</span><span class="p">)</span>

<span class="hll">
</span><span class="nd">@idempotent_function</span><span class="p">(</span><span class="n">data_keyword_argument</span><span class="o">=</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">dynamodb</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">process_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="c1"># create the order_id</span>
    <span class="n">order_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

    <span class="c1"># create your logic to save the order</span>
    <span class="c1"># append the order_id created</span>
    <span class="n">order</span><span class="p">[</span><span class="s2">&quot;order_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order_id</span>

    <span class="c1"># return the order</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">register_lambda_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>  <span class="c1"># see Lambda timeouts section</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing order id </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">process_order</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;order&quot;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;product_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123456789&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;quantity&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<details class="info" open="open">
<summary>Info: Using custom de-serialization?</summary>
<p>The response_hook is called after the custom de-serialization so the payload you process will be the de-serialized version.</p>
</details>
<h4 id="being-a-good-citizen">Being a good citizen<a class="headerlink" href="#being-a-good-citizen" title="Permanent link">&para;</a></h4>
<p>When using response hooks to manipulate returned data from idempotent operations, it's important to follow best practices to avoid introducing complexity or issues. Keep these guidelines in mind:</p>
<ol>
<li>
<p><strong>Response hook works exclusively when operations are idempotent.</strong> The hook will not be called when an operation is not idempotent, or when the idempotent logic fails.</p>
</li>
<li>
<p><strong>Catch and Handle Exceptions.</strong> Your response hook code should catch and handle any exceptions that may arise from your logic. Unhandled exceptions will cause the Lambda function to fail unexpectedly.</p>
</li>
<li>
<p><strong>Keep Hook Logic Simple</strong> Response hooks should consist of minimal and straightforward logic for manipulating response data. Avoid complex conditional branching and aim for hooks that are easy to reason about.</p>
</li>
</ol>
<h2 id="compatibility-with-other-utilities">Compatibility with other utilities<a class="headerlink" href="#compatibility-with-other-utilities" title="Permanent link">&para;</a></h2>
<h3 id="json-schema-validation">JSON Schema Validation<a class="headerlink" href="#json-schema-validation" title="Permanent link">&para;</a></h3>
<p>The idempotency utility can be used with the <code>validator</code> decorator. Ensure that idempotency is the innermost decorator.</p>
<details class="warning" open="open">
<summary>Warning</summary>
<p>If you use an envelope with the validator, the event received by the idempotency utility will be the unwrapped
event - not the "raw" event Lambda was invoked with.</p>
<p>Make sure to account for this behavior, if you set the <code>event_key_jmespath</code>.</p>
</details>
<div class="tabbed-set tabbed-alternate" data-tabs="19:2"><input checked="checked" id="using-idempotency-with-validation-utility" name="__tabbed_19" type="radio" /><input id="sample-event_9" name="__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="using-idempotency-with-validation-utility">Using Idempotency with validation utility</label><label for="sample-event_9">Sample Event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">IdempotencyConfig</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.validation</span> <span class="kn">import</span> <span class="n">envelopes</span><span class="p">,</span> <span class="n">validator</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">IdempotencyConfig</span><span class="p">(</span><span class="n">event_key_jmespath</span><span class="o">=</span><span class="s1">&#39;[&quot;message&quot;, &quot;username&quot;]&#39;</span><span class="p">)</span>
<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>


<span class="hll"><span class="nd">@validator</span><span class="p">(</span><span class="n">envelope</span><span class="o">=</span><span class="n">envelopes</span><span class="o">.</span><span class="n">API_GATEWAY_HTTP</span><span class="p">)</span>
</span><span class="nd">@idempotent</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span> <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;routeKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$default&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;rawPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/my/path&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;rawQueryString&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;parameter1=value1&amp;parameter1=value2&amp;parameter2=value&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;cookies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;cookie1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;cookie2&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Header1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Header2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1,value2&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;queryStringParameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;parameter1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1,value2&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;parameter2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;requestContext&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;accountId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123456789012&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;apiId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;api-id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;authentication&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;clientCert&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;clientCertPem&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CERT_CONTENT&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;subjectDN&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www.example.com&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;issuerDN&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Example issuer&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;serialNumber&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a1:a1:a1:a1:a1:a1:a1:a1:a1:a1:a1:a1:a1:a1:a1:a1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;validity&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;notBefore&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;May 28 12:30:02 2019 GMT&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;notAfter&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Aug  5 09:36:04 2021 GMT&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;authorizer&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;jwt&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;claims&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;claim1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;claim2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2&quot;</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;scopes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="s2">&quot;scope1&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="s2">&quot;scope2&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;domainName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;id.execute-api.us-east-1.amazonaws.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;domainPrefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;http&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/my/path&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;protocol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HTTP/1.1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;sourceIp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.0.1/32&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;userAgent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;agent&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;requestId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;routeKey&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$default&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;$default&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;12/Mar/2020:19:03:58 +0000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;timeEpoch&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1583348638390</span>
<span class="w">  </span><span class="p">},</span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;{\&quot;message\&quot;: \&quot;hello world\&quot;, \&quot;username\&quot;: \&quot;tom\&quot;}&quot;</span><span class="p">,</span>
</span><span class="w">  </span><span class="nt">&quot;pathParameters&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;parameter1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;isBase64Encoded&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;stageVariables&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;stageVariable1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;stageVariable2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2&quot;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<details class="tip" open="open">
<summary>Tip: JMESPath Powertools for AWS Lambda (Python) functions are also available</summary>
<p>Built-in functions known in the validation utility like <code>powertools_json</code>, <code>powertools_base64</code>, <code>powertools_base64_gzip</code> are also available to use in this utility.</p>
</details>
<h3 id="tracer">Tracer<a class="headerlink" href="#tracer" title="Permanent link">&para;</a></h3>
<p>The idempotency utility can be used with the <code>tracer</code> decorator. Ensure that idempotency is the innermost decorator.</p>
<h4 id="first-execution">First execution<a class="headerlink" href="#first-execution" title="Permanent link">&para;</a></h4>
<p>During the first execution with a payload, Lambda performs a <code>PutItem</code> followed by an <code>UpdateItem</code> operation to persist the record in DynamoDB.</p>
<p><img alt="Tracer showcase" src="../../media/idempotency_first_execution.png" /></p>
<h4 id="subsequent-executions">Subsequent executions<a class="headerlink" href="#subsequent-executions" title="Permanent link">&para;</a></h4>
<p>On subsequent executions with the same payload, Lambda optimistically tries to save the record in DynamoDB. If the record already exists, DynamoDB returns the item.</p>
<p>Explore how to handle conditional write errors in high-concurrency scenarios with DynamoDB in this <a href="https://aws.amazon.com/pt/blogs/database/handle-conditional-write-errors-in-high-concurrency-scenarios-with-amazon-dynamodb/" target="_blank">blog post</a>.</p>
<p><img alt="Tracer showcase" src="../../media/idempotency_second_execution.png" /></p>
<h2 id="testing-your-code">Testing your code<a class="headerlink" href="#testing-your-code" title="Permanent link">&para;</a></h2>
<p>The idempotency utility provides several routes to test your code.</p>
<h3 id="disabling-the-idempotency-utility">Disabling the idempotency utility<a class="headerlink" href="#disabling-the-idempotency-utility" title="Permanent link">&para;</a></h3>
<p>When testing your code, you may wish to disable the idempotency logic altogether and focus on testing your business logic. To do this, you can set the environment variable <code>POWERTOOLS_IDEMPOTENCY_DISABLED</code>
with a truthy value. If you prefer setting this for specific tests, and are using Pytest, you can use <a href="https://docs.pytest.org/en/latest/monkeypatch.html" rel="nofollow" target="_blank">monkeypatch</a> fixture:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="20:2"><input checked="checked" id="test_disabling_idempotency_utilitypy" name="__tabbed_20" type="radio" /><input id="app_test_disabling_idempotency_utilitypy" name="__tabbed_20" type="radio" /><div class="tabbed-labels"><label for="test_disabling_idempotency_utilitypy">test_disabling_idempotency_utility.py</label><label for="app_test_disabling_idempotency_utilitypy">app_test_disabling_idempotency_utility.py</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="hll"><span class="kn">import</span> <span class="nn">app_test_disabling_idempotency_utility</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">pytest</span>
</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">lambda_context</span><span class="p">():</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">LambdaContext</span><span class="p">:</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
        <span class="n">memory_limit_in_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">invoked_function_arn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:lambda:eu-west-1:809313241:function:test&quot;</span>
        <span class="n">aws_request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;52fdfc07-2182-154f-163f-5f0f9a621d72&quot;</span>

        <span class="k">def</span> <span class="nf">get_remaining_time_in_millis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">5</span>

    <span class="k">return</span> <span class="n">LambdaContext</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_idempotent_lambda_handler</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">,</span> <span class="n">lambda_context</span><span class="p">):</span>
<span class="hll">    <span class="c1"># Set POWERTOOLS_IDEMPOTENCY_DISABLED before calling decorated functions</span>
</span><span class="hll">    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;POWERTOOLS_IDEMPOTENCY_DISABLED&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">app_test_disabling_idempotency_utility</span><span class="o">.</span><span class="n">lambda_handler</span><span class="p">({},</span> <span class="n">lambda_context</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;IdempotencyTable&quot;</span><span class="p">)</span>


<span class="hll"><span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;expensive operation&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="testing-with-dynamodb-local">Testing with DynamoDB Local<a class="headerlink" href="#testing-with-dynamodb-local" title="Permanent link">&para;</a></h3>
<p>To test with <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.DownloadingAndRunning.html" target="_blank">DynamoDB Local</a>, you can replace the <code>DynamoDB client</code> used by the persistence layer with one you create inside your tests. This allows you to set the endpoint_url.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="21:2"><input checked="checked" id="test_with_dynamodb_localpy" name="__tabbed_21" type="radio" /><input id="app_test_dynamodb_localpy" name="__tabbed_21" type="radio" /><div class="tabbed-labels"><label for="test_with_dynamodb_localpy">test_with_dynamodb_local.py</label><label for="app_test_dynamodb_localpy">app_test_dynamodb_local.py</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="hll"><span class="kn">import</span> <span class="nn">app_test_dynamodb_local</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">pytest</span>
</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">lambda_context</span><span class="p">():</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">LambdaContext</span><span class="p">:</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
        <span class="n">memory_limit_in_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">invoked_function_arn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:lambda:eu-west-1:809313241:function:test&quot;</span>
        <span class="n">aws_request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;52fdfc07-2182-154f-163f-5f0f9a621d72&quot;</span>

        <span class="k">def</span> <span class="nf">get_remaining_time_in_millis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">5</span>

    <span class="k">return</span> <span class="n">LambdaContext</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_idempotent_lambda</span><span class="p">(</span><span class="n">lambda_context</span><span class="p">):</span>
    <span class="c1"># Configure the boto3 to use the endpoint for the DynamoDB Local instance</span>
<span class="hll">    <span class="n">dynamodb_local_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">,</span> <span class="n">endpoint_url</span><span class="o">=</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">)</span>
</span><span class="hll">    <span class="n">app_test_dynamodb_local</span><span class="o">.</span><span class="n">persistence_layer</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">dynamodb_local_client</span>
</span>
    <span class="c1"># If desired, you can use a different DynamoDB Local table name than what your code already uses</span>
    <span class="c1"># app.persistence_layer.table_name = &quot;another table name&quot; # noqa: ERA001</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">app_test_dynamodb_local</span><span class="o">.</span><span class="n">handler</span><span class="p">({</span><span class="s2">&quot;testkey&quot;</span><span class="p">:</span> <span class="s2">&quot;testvalue&quot;</span><span class="p">},</span> <span class="n">lambda_context</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;payment_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">12345</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;IdempotencyTable&quot;</span><span class="p">)</span>


<span class="hll"><span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;expensive operation&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="how-do-i-mock-all-dynamodb-io-operations">How do I mock all DynamoDB I/O operations<a class="headerlink" href="#how-do-i-mock-all-dynamodb-io-operations" title="Permanent link">&para;</a></h3>
<p>The idempotency utility lazily creates the dynamodb <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/dynamodb.html#table" target="_blank">Table</a> which it uses to access DynamoDB.
This means it is possible to pass a mocked Table resource, or stub various methods.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="22:2"><input checked="checked" id="test_with_io_operationspy" name="__tabbed_22" type="radio" /><input id="app_test_io_operationspy" name="__tabbed_22" type="radio" /><div class="tabbed-labels"><label for="test_with_io_operationspy">test_with_io_operations.py</label><label for="app_test_io_operationspy">app_test_io_operations.py</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span>

<span class="hll"><span class="kn">import</span> <span class="nn">app_test_io_operations</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">pytest</span>
</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">lambda_context</span><span class="p">():</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">LambdaContext</span><span class="p">:</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
        <span class="n">memory_limit_in_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">invoked_function_arn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:lambda:eu-west-1:809313241:function:test&quot;</span>
        <span class="n">aws_request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;52fdfc07-2182-154f-163f-5f0f9a621d72&quot;</span>

        <span class="k">def</span> <span class="nf">get_remaining_time_in_millis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">5</span>

    <span class="k">return</span> <span class="n">LambdaContext</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_idempotent_lambda</span><span class="p">(</span><span class="n">lambda_context</span><span class="p">):</span>
<span class="hll">    <span class="n">mock_client</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
</span><span class="hll">    <span class="n">app_test_io_operations</span><span class="o">.</span><span class="n">persistence_layer</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">mock_client</span>
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">app_test_io_operations</span><span class="o">.</span><span class="n">handler</span><span class="p">({</span><span class="s2">&quot;testkey&quot;</span><span class="p">:</span> <span class="s2">&quot;testvalue&quot;</span><span class="p">},</span> <span class="n">lambda_context</span><span class="p">)</span>
<span class="hll">    <span class="n">mock_client</span><span class="o">.</span><span class="n">put_item</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
</span>    <span class="k">assert</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DynamoDBPersistenceLayer</span><span class="p">,</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>

<span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">DynamoDBPersistenceLayer</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;IdempotencyTable&quot;</span><span class="p">)</span>


<span class="hll"><span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;expensive operation&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
        <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="testing-with-redis">Testing with Redis<a class="headerlink" href="#testing-with-redis" title="Permanent link">&para;</a></h3>
<p>To test locally, you can either utilize <a href="https://github.com/cunla/fakeredis-py">fakeredis-py</a> for a simulated Redis environment or refer to the <a href="https://github.com/aws-powertools/powertools-lambda-python/blob/ba6532a1c73e20fdaee88c5795fd40e978553e14/tests/functional/idempotency/persistence/test_redis_layer.py#L34-L66">MockRedis</a> class used in our tests to mock Redis operations.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="23:2"><input checked="checked" id="test_with_mock_redispy" name="__tabbed_23" type="radio" /><input id="mock_redispy" name="__tabbed_23" type="radio" /><div class="tabbed-labels"><label for="test_with_mock_redispy">test_with_mock_redis.py</label><label for="mock_redispy">mock_redis.py</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="hll">
</span><span class="hll"><span class="kn">import</span> <span class="nn">pytest</span>
</span><span class="kn">from</span> <span class="nn">mock_redis</span> <span class="kn">import</span> <span class="n">MockRedis</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.redis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RedisCachePersistenceLayer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">lambda_context</span><span class="p">():</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">LambdaContext</span><span class="p">:</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
        <span class="n">memory_limit_in_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">invoked_function_arn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:lambda:eu-west-1:809313241:function:test&quot;</span>
        <span class="n">aws_request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;52fdfc07-2182-154f-163f-5f0f9a621d72&quot;</span>

        <span class="k">def</span> <span class="nf">get_remaining_time_in_millis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1000</span>

    <span class="k">return</span> <span class="n">LambdaContext</span><span class="p">()</span>

<span class="hll">
</span><span class="k">def</span> <span class="nf">test_idempotent_lambda</span><span class="p">(</span><span class="n">lambda_context</span><span class="p">):</span>
<span class="hll">    <span class="c1"># Init the Mock redis client</span>
</span>    <span class="n">redis_client</span> <span class="o">=</span> <span class="n">MockRedis</span><span class="p">(</span><span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Establish persistence layer using the mock redis client</span>
    <span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">RedisCachePersistenceLayer</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">redis_client</span><span class="p">)</span>

    <span class="c1"># setup idempotent with redis persistence layer</span>
    <span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;expensive operation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># Inovke the sim lambda handler</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">lambda_handler</span><span class="p">({</span><span class="s2">&quot;testkey&quot;</span><span class="p">:</span> <span class="s2">&quot;testvalue&quot;</span><span class="p">},</span> <span class="n">lambda_context</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;payment_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">12345</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>


<span class="c1"># Mock redis class that includes all operations we used in Idempotency</span>
<span class="k">class</span> <span class="nc">MockRedis</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decode_responses</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expire_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decode_responses</span> <span class="o">=</span> <span class="n">decode_responses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acl</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">hset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expire_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span>

    <span class="k">def</span> <span class="nf">from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">expire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expire_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">time</span>

    <span class="c1"># return {} if no match</span>
    <span class="k">def</span> <span class="nf">hgetall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expire_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="nf">get_connection_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;decode_responses&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_responses</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>If you want to set up a real Redis client for integration testing, you can reference the code provided below.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="24:2"><input checked="checked" id="test_with_real_redispy" name="__tabbed_24" type="radio" /><input id="makefile" name="__tabbed_24" type="radio" /><div class="tabbed-labels"><label for="test_with_real_redispy">test_with_real_redis.py</label><label for="makefile">Makefile</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="hll"><span class="kn">import</span> <span class="nn">pytest</span>
</span><span class="hll"><span class="kn">import</span> <span class="nn">redis</span>
</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">idempotent</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.idempotency.persistence.redis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">RedisCachePersistenceLayer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">lambda_context</span><span class="p">():</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">LambdaContext</span><span class="p">:</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
        <span class="n">memory_limit_in_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">invoked_function_arn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:lambda:eu-west-1:809313241:function:test&quot;</span>
        <span class="n">aws_request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;52fdfc07-2182-154f-163f-5f0f9a621d72&quot;</span>

        <span class="k">def</span> <span class="nf">get_remaining_time_in_millis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1000</span>

    <span class="k">return</span> <span class="n">LambdaContext</span><span class="p">()</span>

<span class="hll">
</span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">persistence_store_standalone_redis</span><span class="p">():</span>
    <span class="c1"># init a Real Redis client and connect to the Port set in the Makefile</span>
    <span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="s2">&quot;63005&quot;</span><span class="p">,</span>
        <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
<span class="hll">
</span>    <span class="c1"># return a persistence layer with real Redis</span>
    <span class="k">return</span> <span class="n">RedisCachePersistenceLayer</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">redis_client</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_idempotent_lambda</span><span class="p">(</span><span class="n">lambda_context</span><span class="p">,</span> <span class="n">persistence_store_standalone_redis</span><span class="p">):</span>
    <span class="c1"># Establish persistence layer using the real redis client</span>
    <span class="n">persistence_layer</span> <span class="o">=</span> <span class="n">persistence_store_standalone_redis</span>

    <span class="c1"># setup idempotent with redis persistence layer</span>
    <span class="nd">@idempotent</span><span class="p">(</span><span class="n">persistence_store</span><span class="o">=</span><span class="n">persistence_layer</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;expensive operation&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;payment_id&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span>
            <span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># Inovke the sim lambda handler</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">lambda_handler</span><span class="p">({</span><span class="s2">&quot;testkey&quot;</span><span class="p">:</span> <span class="s2">&quot;testvalue&quot;</span><span class="p">},</span> <span class="n">lambda_context</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;payment_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">12345</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>test-idempotency-redis:<span class="w"> </span><span class="c1"># (1)!</span>
<span class="w">    </span>docker<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>test-idempotency-redis<span class="w"> </span>-d<span class="w"> </span>-p<span class="w"> </span><span class="m">63005</span>:6379<span class="w"> </span>redis
<span class="w">    </span>pytest<span class="w"> </span>test_with_real_redis.py<span class="p">;</span>docker<span class="w"> </span>stop<span class="w"> </span>test-idempotency-redis<span class="p">;</span>docker<span class="w"> </span>rm<span class="w"> </span>test-idempotency-redis
</code></pre></div></td></tr></table></div>
<ol>
<li>Use this script to setup a temp Redis docker and auto remove it upon completion</li>
</ol>
</div>
</div>
</div>
<h2 id="extra-resources">Extra resources<a class="headerlink" href="#extra-resources" title="Permanent link">&para;</a></h2>
<p>If you're interested in a deep dive on how Amazon uses idempotency when building our APIs, check out
<a href="https://aws.amazon.com/builders-library/making-retries-safe-with-idempotent-APIs/" target="_blank">this article</a>.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    2024-09-25
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 Amazon Web Services
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://discord.gg/B8zZKbbyET" target="_blank" rel="noopener" title="Discord Server for Powertools for AWS" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485 485 0 0 0 404.081 32.03a1.82 1.82 0 0 0-1.923.91 338 338 0 0 0-14.9 30.6 447.9 447.9 0 0 0-134.426 0 310 310 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.7 483.7 0 0 0-119.688 37.107 1.7 1.7 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.02 2.02 0 0 0 .765 1.375 487.7 487.7 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348 348 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321 321 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251 251 0 0 0 9.109-7.137 1.82 1.82 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.81 1.81 0 0 1 1.924.233 235 235 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.4 301.4 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391 391 0 0 0 30.014 48.815 1.86 1.86 0 0 0 2.063.7A486 486 0 0 0 610.7 405.729a1.88 1.88 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541M222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241m195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241"/></svg>
    </a>
  
    
    
    
    
    <a href="https://powertools.aws.dev/" target="_blank" rel="noopener" title="Official website for Powertools for AWS" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2m-5.15 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56M14.34 14H9.66c-.1-.66-.16-1.32-.16-2s.06-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2M12 19.96c-.83-1.2-1.5-2.53-1.91-3.96h3.82c-.41 1.43-1.08 2.76-1.91 3.96M8 8H5.08A7.92 7.92 0 0 1 9.4 4.44C8.8 5.55 8.35 6.75 8 8m-2.92 8H8c.35 1.25.8 2.45 1.4 3.56A8 8 0 0 1 5.08 16m-.82-2C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2M12 4.03c.83 1.2 1.5 2.54 1.91 3.97h-3.82c.41-1.43 1.08-2.77 1.91-3.97M18.92 8h-2.95a15.7 15.7 0 0 0-1.38-3.56c1.84.63 3.37 1.9 4.33 3.56M12 2C6.47 2 2 6.5 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://pypi.org/project/aws-lambda-powertools/" target="_blank" rel="noopener" title="PyPi package" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.25.18.9.2.73.26.59.3.45.32.34.34.25.34.16.33.1.3.04.26.02.2-.01.13V8.5l-.05.63-.13.55-.21.46-.26.38-.3.31-.33.25-.35.19-.35.14-.33.1-.3.07-.26.04-.21.02H8.77l-.69.05-.59.14-.5.22-.41.27-.33.32-.27.35-.2.36-.15.37-.1.35-.07.32-.04.27-.02.21v3.06H3.17l-.21-.03-.28-.07-.32-.12-.35-.18-.36-.26-.36-.36-.35-.46-.32-.59-.28-.73-.21-.88-.14-1.05-.05-1.23.06-1.22.16-1.04.24-.87.32-.71.36-.57.4-.44.42-.33.42-.24.4-.16.36-.1.32-.05.24-.01h.16l.06.01h8.16v-.83H6.18l-.01-2.75-.02-.37.05-.34.11-.31.17-.28.25-.26.31-.23.38-.2.44-.18.51-.15.58-.12.64-.1.71-.06.77-.04.84-.02 1.27.05zm-6.3 1.98-.23.33-.08.41.08.41.23.34.33.22.41.09.41-.09.33-.22.23-.34.08-.41-.08-.41-.23-.33-.33-.22-.41-.09-.41.09zm13.09 3.95.28.06.32.12.35.18.36.27.36.35.35.47.32.59.28.73.21.88.14 1.04.05 1.23-.06 1.23-.16 1.04-.24.86-.32.71-.36.57-.4.45-.42.33-.42.24-.4.16-.36.09-.32.05-.24.02-.16-.01h-8.22v.82h5.84l.01 2.76.02.36-.05.34-.11.31-.17.29-.25.25-.31.24-.38.2-.44.17-.51.15-.58.13-.64.09-.71.07-.77.04-.84.01-1.27-.04-1.07-.14-.9-.2-.73-.25-.59-.3-.45-.33-.34-.34-.25-.34-.16-.33-.1-.3-.04-.25-.02-.2.01-.13v-5.34l.05-.64.13-.54.21-.46.26-.38.3-.32.33-.24.35-.2.35-.14.33-.1.3-.06.26-.04.21-.02.13-.01h5.84l.69-.05.59-.14.5-.21.41-.28.33-.32.27-.35.2-.36.15-.36.1-.35.07-.32.04-.28.02-.21V6.07h2.09l.14.01zm-6.47 14.25-.23.33-.08.41.08.41.23.33.33.23.41.08.41-.08.33-.23.23-.33.08-.41-.08-.41-.23-.33-.33-.23-.41-.08-.41.08z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["header.autohide", "navigation.sections", "navigation.top", "navigation.instant", "navigation.indexes", "navigation.tracking", "navigation.tabs", "content.code.annotate", "content.code.copy", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.525ec568.min.js"></script>
      
        <script src="../../javascript/aws-amplify.min.js"></script>
      
        <script src="../../javascript/extra.js"></script>
      
        <script src="https://docs.powertools.aws.dev/shared/mermaid.min.js"></script>
      
    
  </body>
</html>